1.INVALIDATE_METADATA

--RELEASE DATE:06/09/2022

invalidate metadata @DB_LEVEL@_edm_other_src_silver.pos_na_stg;
invalidate metadata @DB_LEVEL@_context_silver.ctx_sales;
invalidate metadata @DB_LEVEL@_context_silver.ctx_inventory;
invalidate metadata @DB_LEVEL@_context_silver.ctx_channel;
invalidate metadata @DB_LEVEL@_cld_cpq_silver.cpq_price_book_associations;
invalidate metadata @DB_LEVEL@_mdm_hub_gold.d_customer_header_v;
invalidate metadata @DB_LEVEL@_mdm_hub_gold.d_customer_address_v;
invalidate metadata @DB_LEVEL@_edm_gold.d_product;
invalidate metadata @DB_LEVEL@_edm_gold.d_product_catalog;
invalidate metadata @DB_LEVEL@_edm_other_src_silver.pos_na_temp;
invalidate metadata @DB_LEVEL@_edm_other_src_silver.canada_pos_cd_lst;
invalidate metadata @DB_LEVEL@_edm_other_src_silver.usa_pos_cd_lst;
invalidate metadata @DB_LEVEL@_edm_other_src_silver.rep_office_info;
invalidate metadata @DB_LEVEL@_edm_other_src_silver.product_family_classification;
invalidate metadata @DB_LEVEL@_edm_other_src_silver.americas_channel_commission_sp1_dop_claim;
invalidate metadata @DB_LEVEL@_edm_other_src_silver.americas_channel_comission_sp2_dop_claim;
invalidate metadata @DB_LEVEL@_na_cld_osc_gold.pos_na;

2.Populate_stage_table

INSERT
	INTO
	@DB_LEVEL@_edm_other_src_silver.pos_na_stg
SELECT
	AccountServiceSales,
	AccountSubType,
	AccountType,
	Activated,
	ACTIVEDATE,
	AssignmentTerritory,
	BillToCustomerAddress,
	BillToCustomerCity,
	BillToCustomerCountry,
	BillToCustomerEnterpriseIndustry,
	BillToCustomerGICSInudstryGroupDescription,
	BillToCustomerGICSSectorDescription,
	BillToCustomerGSC,
	BillToCustomerID,
	BillToCustomerIndustry,
	BillToCustomerName,
	BillToCustomerNumber,
	BillToCustomerParentAccount,
	BillToCustomerParentName,
	BillToCustomerPostalCode,
	BillToCustomerReportingName,
	BillToCustomerStandardizedName,
	BillToCustomerState,
	BillToCustomerSubVertical,
	BillToCustomerType,
	BillToCustomerVertical,
	BillToEnterpriseIndustry,
	BillToGSC_Flag,
	BillToIndustry,
	BillToIndustryCode,
	BillToNonRevenueFlag,
	BillToParentAccount,
	BillToStandardizedName,
	CDWSalesArea,
	CDWSalesRegion,
	CDWSalesSegment,
	CloudListPrice,
	COE,
	Country,
	CrossRefWithlesnumber,
	Currency,
	EndCustomerAccountRole,
	EndCustomerAddress,
	EndCustomerCity,
	EndCustomerCountry,
	EndCustomerCustomerType1,
	EndCustomerEnterpriseIndustry,
	EndCustomerGSCFlag,
	EndCustomerID,
	EndCustomerIndustry1,
	EndCustomerIndustryCode1,
	EndCustomerName,
	EndCustomerParentAccount,
	EndCustomerPostalCode,
	EndCustomerStandardizedName,
	EndCustomerState,
	EndCustomerSubVertical,
	EndCustomerVertical,
	ExtendedListPrice,
	ExtendedStandardCost,
	GBU,
	hashedBillToCustomerName,
	hashedEndCustomerName,
	hashedShipToCustomerName,
	hashedSoldtoCustomerName,
	InternalOfficeFamily,
	InternalOfficeName,
	InternalOfficeNumber,
	InternalOfficePrincipalEmail,
	InternalOfficePrincipalName,
	InternalOfficeRegion,
	InternalOfficeSplit,
	InternalOfficeTerritory,
	InternalOfficeType,
	InternalPrincipalEmail,
	InternalPrincipalName,
	InvoiceDate,
	InvoiceLineNumber,
	InvoiceNumber,
	level6,
	ListPrice,
	LOB,
	Multiplier,
	NamedAccountOfficeAssign,
	NamedAccountSplit,
	NetSalesRevenue,
	NewLESCrossRef2,
	OEMTag,
	officeLocation,
	officetype,
	OriginalSplitPercent,
	POSProjectRegistrationNumber,
	POSSKU,
	PostalCodesOfficeAssign,
	productcategory,
	productfamily,
	ProductHierarchyLevel1Description,
	ProductHierarchyLevel2Description,
	ProductHierarchyLevel3Description,
	ProductHierarchyLevel4Code,
	ProductHierarchyLevel4Description,
	QuantityShipped,
	RecordID,
	RecordSource,
	Region,
	ResellerBranchName,
	ResellerBranchNumber,
	ResellerMajorCode,
	ResellerMinorCode,
	ResellerName,
	ResellerNumber,
	ResellerPartnerLevel,
	ResellerPartnerType,
	ResellerRegion,
	ResellerSalesOfficeName,
	ResellerSalesOfficeNumber,
	ResponseID,
	Sales_Area,
	SalesOfficeFamily,
	SalesOfficeName,
	SalesOfficeNumber,
	SalesOfficeNumber2,
	SalesOfficePrincipalEmail,
	SalesOfficePrincipalName,
	SalesOfficeRegion,
	SalesOfficeTerritory,
	SalesOrderNumber,
	SalesOutPrimaryKey,
	salesRegion,
	salesRegion2,
	SalesRepEmail,
	SalesRepID,
	SalesRepName,
	Segment,
	ShipToCustomerAddress,
	ShipToCustomerCity,
	ShipToCustomerCountry,
	ShipToCustomerEnterpriseIndustry,
	ShipToCustomerGSC,
	ShipToCustomerID,
	ShipToCustomerIndustry1,
	ShipToCustomerName,
	ShipToCustomerNumber,
	ShipToCustomerParentAccount,
	ShipToCustomerParentName,
	ShipToCustomerPostalCode,
	ShipToCustomerStandardizedName,
	ShipToCustomerState,
	ShipToCustomerSubVertical,
	ShipToCustomerType1,
	ShipToCustomerType1_2,
	ShipToCustomerVertical,
	ShipToEnterpriseIndustry,
	ShipToGSC_Flag,
	ShipToIndustry1,
	ShipToParentAccount,
	ShipToStandardizedName,
	SizeCategory,
	SKU,
	SKUDescription,
	SoldToCustomerAddress,
	SoldToCustomerCity,
	SoldToCustomerCountry,
	SoldToCustomerCustomerGSC,
	SoldToCustomerCustomerType1,
	SoldToCustomerIndustry1,
	SoldToCustomerName,
	SoldToCustomerNumber,
	SoldToCustomerParentAccount,
	SoldToCustomerPostalCode,
	SoldToCustomerState,
	SoldToCustomerSubVertical,
	SoldToCustomerVertical,
	SP1ProductFlag,
	SP1TargetAccountFlag,
	SP2ProductFlag,
	SP2TargetAccountFlag,
	SPEED_DIAL,
	SplitPercent,
	Standard_Products,
	StandardCost,
	TransactionAmount,
	TransactionType,
	YearMonth,
	intrachannelflag,
	now() as w_insert_dtm,
	endcustomernumber,
	--SO-621 attributes addition starts
	upper(BillToCustomerClassCode),
	upper(EndCustomerClassCode),
	upper(ShipToCustomerClassCode),
	upper(SoldToCustomerClassCode),
	upper(BillToCustomerPartnerClassCode),
	upper(EndCustomerPartnerClassCode),
	upper(ShipToCustomerPartnerClassCode),
	upper(SoldToCustomerPartnerClassCode),
	BillToOracleRegistryID, 
	EndOracleRegistryID,
	ShipToOracleRegistryID,
	SoldToOracleRegistryID,
	upper(BillToCustomerIndustry1),
	upper(BillToCustomerIndustry3),
	upper(EndCustomerIndustry3),
	upper(ShipToCustomerIndustry3),
	upper(SoldToCustomerIndustry3),
	upper(BillToReportingSubParent1),
	upper(EndReportingSubParent1),
	upper(ShipToReportingSubParent1),
	upper(SoldToReportingSubParent1),
	BillToDefinitiveIDNID,
	EndDefinitiveIDNID,
	ShipToDefinitiveIDNID,
	SoldToDefinitiveIDNID,
	BillToDefinitiveIDNIDParentID,
	EndDefinitiveIDNIDParentID,
	ShipToDefinitiveIDNIDParentID,
	SoldToDefinitiveIDNIDParentID,
	BillToNCESLEAID,
	EndNCESLEAID,
	ShipToNCESLEAID,
	SoldToNCESLEAID,
	upper(BillToCustomerProvince),
	upper(EndCustomerProvince),
	upper(ShipToCustomerProvince),
	upper(SoldToCustomerProvince),
	BillToOraclePartySiteNumber,  
	EndOraclePartySiteNumber,
	ShipToOraclePartySiteNumber,
	SoldToOraclePartySiteNumber,
	BillToDefinitiveID,
	EndDefinitiveID,
	ShipToDefinitiveID,
	SoldToDefinitiveID,
	BillToNCESSCHID,
	EndNCESSCHID,
	ShipToNCESSCHID,
	SoldToNCESSCHID,
	--so-621 new attributes addition ends
	--so-661 new attributes addition starts
	upper(BillToAccountType),
	upper(EndAccountType),
	upper(ShipToAccountType),
	upper(SoldToAccountType),
	--so-661 new attributes addition ends
	productcommissionclasscode,  --so-665 new attributes addition starts
	upper(BillToServicesMajorAcc),
	upper(EndServicesMajorAcc),
	upper(ShipToServicesMajorAcc),
	upper(SoldToServicesMajorAcc),  --so-665 new attributes addition ends
	upper(BillToCustomerSubClass), --so-728 new attributes addition starts
	upper(EndCustomerSubClass),
	upper(ShipToCustomerSubClass),
	upper(SoldToCustomerSubClass), --so-728 new attributes addition ends
	upper(SerialNumber)
FROM
	(
	SELECT
		'' AccountServiceSales,
		'' AccountSubType,
		'' AccountType,
		'' Activated,
		'' ACTIVEDATE,
		'' AssignmentTerritory,
		nvl(bill_sold_ca.site_address1_txt,cc.address) BillToCustomerAddress,
		nvl(bill_sold_ch.city_primary_txt,cc.city) BillToCustomerCity,
		nvl(bill_sold_ch.country_primary_cd,cc.country_iso_name) BillToCustomerCountry,
		'' BillToCustomerEnterpriseIndustry,
		'' BillToCustomerGICSInudstryGroupDescription,
		'' BillToCustomerGICSSectorDescription,
		'' BillToCustomerGSC,
		cs.context_reseller_id BillToCustomerID,
		coalesce(bill_sold_ch.industry_classification_1_txt, bill_sold_ch.industry_classification_2_txt, bill_sold_ch.industry_classification_3_txt) BillToCustomerIndustry,
		nvl(bill_sold_ch.customer_name_txt,upper(cc.name)) BillToCustomerName, 
		nvl(bill_sold_ch.customer_number,cs.context_reseller_id) BillToCustomerNumber,
		bill_sold_ch.ultimate_parent_txt BillToCustomerParentAccount,
		'' BillToCustomerParentName,
		--nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code) BillToCustomerPostalCode,   VR 03172022 fix for postal code prefixed zeroes
		case when length(nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code))<5 
			then lpad(nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code), 5,'0')
            else nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code)
		end as BillToCustomerPostalCode,
		'' BillToCustomerReportingName,
		'' BillToCustomerStandardizedName,
		nvl(bill_sold_ca.site_state_cd,cc.postal_code_state) BillToCustomerState,
		bill_sold_ch.market_sub_vertical_txt BillToCustomerSubVertical,
		bill_sold_ch.customer_type_txt BillToCustomerType,
		bill_sold_ch.market_vertical_txt BillToCustomerVertical,
		'' BillToEnterpriseIndustry,
		'' BillToGSC_Flag,
		'' BillToIndustry,
		'' BillToIndustryCode,
		'' BillToNonRevenueFlag,
		bill_sold_ch.ultimate_parent_txt BillToParentAccount,
		'' BillToStandardizedName,
		'' CDWSalesArea,
		cdw.sales_region CDWSalesRegion, --VR 06062022 New changes for SO-683 (CDW fields) 
		cdw.sales_segment CDWSalesSegment, --VR 06062022 New changes for SO-683 (CDW fields)
		cs.buy_in_price CloudListPrice,
		nvl(cat.catalog_lvl_desc_3,gph_sku.coe) COE,
		'' Country,
		'' CrossRefWithlesnumber,
		cs.sell_through_currency Currency,
		'' EndCustomerAccountRole,
		nvl(end_ship_ca.site_address1_txt,cc_sh.address) EndCustomerAddress,
		nvl(end_ship_ch.city_primary_txt,cc_sh.city) EndCustomerCity,
		nvl(end_ship_ch.country_primary_cd,cc_sh.country_iso_name) EndCustomerCountry,
		end_ship_ch.customer_type_txt EndCustomerCustomerType1,
		'' EndCustomerEnterpriseIndustry,
		'' EndCustomerGSCFlag,
		cs.shipped_to_reseller_id EndCustomerID,
		--coalesce(end_ship_ch.industry_classification_1_txt, end_ship_ch.industry_classification_2_txt, end_ship_ch.industry_classification_3_txt) EndCustomerIndustry1,
		nvl(end_ship_ch.industry_classification_1_txt, end_ship_ch.industry_classification_2_txt) EndCustomerIndustry1,--mapping changed for  EndCustomerIndustry1
		'' EndCustomerIndustryCode1,
		--end_cust.customername EndCustomerName, -- Mapping changed for EndCustomerName
		nvl(end_ship_ch.customer_name_txt,upper(cc_sh.name)) EndCustomerName,		--EndCustomerName mapped from ctx_channel.name
		end_ship_ch.ultimate_parent_txt EndCustomerParentAccount,
		--nvl(end_ship_ca.site_postal_code_txt,cc_sh.postal_code) EndCustomerPostalCode, VR 03172022 fix for postal code prefixed zeroes
		case when length(nvl(end_ship_ca.site_postal_code_txt,cc_sh.postal_code))<5 
			then lpad(nvl(end_ship_ca.site_postal_code_txt,cc_sh.postal_code), 5,'0')
            else nvl(end_ship_ca.site_postal_code_txt,cc_sh.postal_code)
		end as EndCustomerPostalCode,		
		'' EndCustomerStandardizedName,
		nvl(end_ship_ca.site_state_cd,cc_sh.postal_code_state) EndCustomerState,
		end_ship_ch.market_sub_vertical_txt EndCustomerSubVertical,
		end_ship_ch.market_vertical_txt EndCustomerVertical,
		--(cs.buy_in_price * cs.quantity) ExtendedListPrice,
		case WHEN (cs.quantity is not null or cs.quantity <>0) then nvl((cpqpb.assoc_price_usd*cs.quantity),cs.buy_in_price)
		ELSE 0
		end ExtendedListPrice, --New ExtendedListPrice changes
		'' ExtendedStandardCost,
		nvl(cat.catalog_lvl_desc_1,gph_sku.gbu) GBU,
		---Mapping is now coming from new join condition not involving f_sales_invoice_line
		cast(fnv_hash('NULL') as STRING) hashedBillToCustomerName,
		---Mapping this to NULL 
		cast(isnull(fnv_hash(fnv_hash(cc.name)),
		fnv_hash('NULL')) as STRING) hashedEndCustomerName,
		--Mapping  from ctx_channel.name
		cast(isnull(fnv_hash(cc.name),
		fnv_hash('NULL')) as STRING) hashedShipToCustomerName,
		--Mapping  from ctx_channel.name
		cast(fnv_hash('NULL') as STRING) hashedSoldtoCustomerName,
		---Mapping this to NULL 
		'' InternalOfficeFamily,
		'' InternalOfficeName,
		'' InternalOfficeNumber,
		'' InternalOfficePrincipalEmail,
		'' InternalOfficePrincipalName,
		'' InternalOfficeRegion,
		'' InternalOfficeSplit,
		'' InternalOfficeTerritory,
		'' InternalOfficeType,
		'' InternalPrincipalEmail,
		'' InternalPrincipalName,
		--cs.transaction_date InvoiceDate,
		to_timestamp(cast(cs.transaction_date AS STRING), 'yyyyMMdd') InvoiceDate,
		'' InvoiceLineNumber,
		cs.invoice_number InvoiceNumber,
		nvl(cat.catalog_lvl_desc_6,gph_sku.level_6) level6,
		---Mapping is now coming from new join condition not involving f_sales_invoice_line
		--cs.buy_in_price ListPrice,
		case when (cs.quantity is not null or cs.quantity <>0) then nvl(cpqpb.assoc_price_usd,(cs.buy_in_price/cs.quantity))
		ELSE 0
		end ListPrice, ---New list price changes
		nvl(cat.catalog_lvl_desc_2,gph_sku.lob) LOB,
		---Mapping is now coming from new join condition not involving f_sales_invoice_line
		(cs.sell_through_revenue / (cs.buy_in_price * cs.quantity)) Multiplier,
		'' NamedAccountOfficeAssign,
		'' NamedAccountSplit,
		cs.buy_in_price NetSalesRevenue,
		'' NewLESCrossRef2,
		'' OEMTag,
		'' officeLocation,
		'' officetype,
		'1' OriginalSplitPercent,
		'' POSProjectRegistrationNumber,
		'' POSSKU,
		'' PostalCodesOfficeAssign,
		nvl(cat.catalog_lvl_desc_4,gph_sku.product_category) productcategory,
		---Mapping is now coming from new join condition not involving f_sales_invoice_line
		nvl(cat.catalog_lvl_desc_5,gph_sku.product_family) productfamily,
		---Mapping is now coming from new join condition not involving f_sales_invoice_line
		'' ProductHierarchyLevel1Description,
		'' ProductHierarchyLevel2Description,
		'' ProductHierarchyLevel3Description,
		'' ProductHierarchyLevel4Code,
		'' ProductHierarchyLevel4Description,
		cs.quantity QuantityShipped,
		concat((concat('context', '_')), cs.sales_series_id) RecordID,		
		--NVL(upper(concat('Context_',cc_re.name)),'CONTEXT')  RecordSource,
		CASE
            WHEN cdw.company_description IS NOT NULL THEN concat('CONTEXT_',upper(cdw.company_description))
            ELSE NVL(upper(concat('Context_',cc_re.name)),'CONTEXT')
        END RecordSource,	--VR 06062022 New changes for SO-683 (CDW fields) 	 	
		'' Region,
		'' ResellerBranchName,
		'' ResellerBranchNumber,
		'' ResellerMajorCode,
		'' ResellerMinorCode,
		--cc.name ResellerName,
        decode(NVL(upper(concat('Context_', cc_re.name)),'CONTEXT'),
				'CONTEXT_CDW','CDW','CONTEXT_GRAYBAR','GRAYBAR',
				'CONTEXT_CONNECTION','PC CONNECTION','CONTEXT_PC_CONNECTION','PC CONNECTION', nvl(bill_sold_ch.customer_name_txt,upper(cc.name)) ) ResellerName,
		cs.context_reseller_id ResellerNumber,
		'' ResellerPartnerLevel,
		'' ResellerPartnerType,
		'' ResellerRegion,
		'' ResellerSalesOfficeName,
		'' ResellerSalesOfficeNumber,
		'' ResponseID,
		'' Sales_Area,
		'' SalesOfficeFamily,
		--- roi Flow changes , marking fields as blank 
		'' SalesOfficeName,
		--- inv Flow changes , marking fields as blank 
		'' SalesOfficeNumber,
		---inv Flow changes , marking fields as blank 
		'' SalesOfficeNumber2,
		'' SalesOfficePrincipalEmail,
		--- roi Flow changes , marking fields as blank 
		'' SalesOfficePrincipalName,
		--- roi Flow changes , marking fields as blank 
		'' SalesOfficeRegion,
		'' SalesOfficeTerritory,
		'' SalesOrderNumber,
		---inv Flow changes , marking fields as blank 
		concat((concat(cc.name, '_')), (concat((concat('context', '_')), cs.sales_series_id))) SalesOutPrimaryKey,
		'' salesRegion,
		--- roi Flow changes , marking fields as blank 
		'' salesRegion2,
		'' SalesRepEmail,
		--rep.sales_rep_num SalesRepID,
		'' SalesRepID,
		--rep.sales_rep_name SalesRepName,
		'' SalesRepName,
		'' Segment,
		nvl(end_ship_ca.site_address1_txt,cc_sh.address) ShipToCustomerAddress,
		nvl(end_ship_ch.city_primary_txt,cc_sh.city) ShipToCustomerCity,
		nvl(end_ship_ca.site_country_cd,cc_sh.country_iso_name) ShipToCustomerCountry,
		'' ShipToCustomerEnterpriseIndustry,
		'' ShipToCustomerGSC,
		cs.shipped_to_reseller_id ShipToCustomerID,
		--coalesce(end_ship_ch.industry_classification_1_txt, end_ship_ch.industry_classification_2_txt, end_ship_ch.industry_classification_3_txt) ShipToCustomerIndustry1,
		nvl(end_ship_ch.industry_classification_1_txt, end_ship_ch.industry_classification_2_txt) ShipToCustomerIndustry1,--mapping changed for ShipToCustomerIndustry1
		nvl(end_ship_ch.customer_name_txt,upper(cc_sh.name)) ShipToCustomerName,
		end_ship_ch.customer_number ShipToCustomerNumber,
		end_ship_ch.ultimate_parent_txt ShipToCustomerParentAccount,
		'' ShipToCustomerParentName,
		--nvl(cc_sh.postal_code,end_ship_ca.site_postal_code_txt) ShipToCustomerPostalCode, VR 03172022 fix for postal code prefixed zeroes
		case when length(nvl(cc_sh.postal_code,end_ship_ca.site_postal_code_txt))<5 
			then lpad(nvl(cc_sh.postal_code,end_ship_ca.site_postal_code_txt), 5,'0')
            else nvl(cc_sh.postal_code,end_ship_ca.site_postal_code_txt)
		end as ShipToCustomerPostalCode,		
		'' ShipToCustomerStandardizedName,
		nvl(end_ship_ca.site_state_cd,cc_sh.postal_code_state) ShipToCustomerState,
		end_ship_ch.market_sub_vertical_txt ShipToCustomerSubVertical,
		'' ShipToCustomerType1,
		'' ShipToCustomerType1_2,
		end_ship_ch.market_vertical_txt ShipToCustomerVertical,
		'' ShipToEnterpriseIndustry,
		'' ShipToGSC_Flag,
		'' ShipToIndustry1,
		end_ship_ch.ultimate_parent_txt ShipToParentAccount,
		'' ShipToStandardizedName,
		'' SizeCategory,
		coalesce(cs.part_no,gph_sku.context_sku,'Unmatched SKU') SKU,
		--isnull(cs.part_no,'Unmatched SKU') SKU, --adding null condition for SKU as per RH
		--prod.product_desc SKUDescription, --- removing old mapping for d_product
		isnull(dp.product_desc,'Unmatched SKU Description') SKUDescription, --adding new mapping for d_product & adding null condition for SKU as per RH
		nvl(bill_sold_ca.site_address1_txt,cc.address) SoldToCustomerAddress,
		nvl(bill_sold_ch.city_primary_txt,cc.city) SoldToCustomerCity,
		nvl(bill_sold_ch.country_primary_cd,cc.country_iso_name) SoldToCustomerCountry,
		'' SoldToCustomerCustomerGSC,
		'' SoldToCustomerCustomerType1,
		--'' SoldToCustomerIndustry1,
		--coalesce(bill_sold_ch.industry_classification_1_txt, bill_sold_ch.industry_classification_2_txt, bill_sold_ch.industry_classification_3_txt) SoldToCustomerIndustry1,
		nvl(bill_sold_ch.industry_classification_1_txt, bill_sold_ch.industry_classification_2_txt) SoldToCustomerIndustry1, --mapping changed for SoldToCustomerIndustry1
		nvl(bill_sold_ch.customer_name_txt,upper(cc.name)) SoldToCustomerName,
		nvl(bill_sold_ch.customer_number,cs.context_reseller_id) SoldToCustomerNumber,
		bill_sold_ch.ultimate_parent_txt SoldToCustomerParentAccount,
		--nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code) SoldToCustomerPostalCode, VR 03172022 fix for postal code prefixed zeroes
		case when length(nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code))<5 
			then lpad(nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code), 5,'0')
            else nvl(bill_sold_ca.site_postal_code_txt,cc.postal_code)
		end as SoldToCustomerPostalCode,		
		nvl(bill_sold_ca.site_state_cd,cc.postal_code_state) SoldToCustomerState,
		bill_sold_ch.market_sub_vertical_txt SoldToCustomerSubVertical,
		bill_sold_ch.market_vertical_txt SoldToCustomerVertical,
		'' SP1ProductFlag,
		'' SP1TargetAccountFlag,
		'' SP2ProductFlag,
		'' SP2TargetAccountFlag,
		'' SPEED_DIAL,
		'' SplitPercent,
		'' Standard_Products,
		'' StandardCost,
		cs.sell_through_revenue TransactionAmount,
		'INVOICED' TransactionType,
		cs.transaction_date YearMonth,
		cs.intrachannel intrachannelflag,
		cs.shipped_to_reseller_id endcustomernumber,
		--so-621 new mdm attributes addition starts
		bill_sold_ch.customer_class_code_txt BillToCustomerClassCode,
		end_ship_ch.customer_class_code_txt EndCustomerClassCode,
		end_ship_ch.customer_class_code_txt ShipToCustomerClassCode,
		bill_sold_ch.customer_class_code_txt SoldToCustomerClassCode,
		bill_sold_ch.partner_class_code_txt BillToCustomerPartnerClassCode,
		end_ship_ch.partner_class_code_txt EndCustomerPartnerClassCode,
		end_ship_ch.partner_class_code_txt ShipToCustomerPartnerClassCode,
		bill_sold_ch.partner_class_code_txt SoldToCustomerPartnerClassCode,
		bill_sold_ch.oracle_cloud_registry_id BillToOracleRegistryID, 
		end_ship_ch.oracle_cloud_registry_id EndOracleRegistryID,
		end_ship_ch.oracle_cloud_registry_id ShipToOracleRegistryID,
		bill_sold_ch.oracle_cloud_registry_id SoldToOracleRegistryID,
		nvl(bill_sold_ch.industry_classification_1_txt, bill_sold_ch.industry_classification_2_txt) BillToCustomerIndustry1,
		bill_sold_ch.industry_classification_3_txt BillToCustomerIndustry3,
		end_ship_ch.industry_classification_3_txt EndCustomerIndustry3,
		end_ship_ch.industry_classification_3_txt ShipToCustomerIndustry3,
		bill_sold_ch.industry_classification_3_txt SoldToCustomerIndustry3,
		bill_sold_ch.reporting_sub_parent1 BillToReportingSubParent1,
		end_ship_ch.reporting_sub_parent1 EndReportingSubParent1,
		end_ship_ch.reporting_sub_parent1 ShipToReportingSubParent1,
		bill_sold_ch.reporting_sub_parent1 SoldToReportingSubParent1,
		bill_sold_ch.definitive_idn_id BillToDefinitiveIDNID,
		end_ship_ch.definitive_idn_id EndDefinitiveIDNID,
		end_ship_ch.definitive_idn_id ShipToDefinitiveIDNID,
		bill_sold_ch.definitive_idn_id SoldToDefinitiveIDNID,
		bill_sold_ch.definitive_idn_parentid BillToDefinitiveIDNIDParentID,
		end_ship_ch.definitive_idn_parentid EndDefinitiveIDNIDParentID,
		end_ship_ch.definitive_idn_parentid ShipToDefinitiveIDNIDParentID,
		bill_sold_ch.definitive_idn_parentid SoldToDefinitiveIDNIDParentID,
		bill_sold_ch.nces_leaid BillToNCESLEAID,
		end_ship_ch.nces_leaid EndNCESLEAID,
		end_ship_ch.nces_leaid ShipToNCESLEAID,
		bill_sold_ch.nces_leaid SoldToNCESLEAID,
		bill_sold_ca.site_province_cd BillToCustomerProvince,
		end_ship_ca.site_province_cd EndCustomerProvince,
		end_ship_ca.site_province_cd ShipToCustomerProvince,
		bill_sold_ca.site_province_cd SoldToCustomerProvince,
		bill_sold_ca.oracle_cloud_party_site_number BillToOraclePartySiteNumber,  
		end_ship_ca.oracle_cloud_party_site_number EndOraclePartySiteNumber,
		end_ship_ca.oracle_cloud_party_site_number ShipToOraclePartySiteNumber,
		bill_sold_ca.oracle_cloud_party_site_number SoldToOraclePartySiteNumber,
		bill_sold_ca.definitive_id BillToDefinitiveID,
		end_ship_ca.definitive_id EndDefinitiveID,
		end_ship_ca.definitive_id ShipToDefinitiveID,
		bill_sold_ca.definitive_id SoldToDefinitiveID,
		bill_sold_ca.nces_schid BillToNCESSCHID,
		end_ship_ca.nces_schid EndNCESSCHID,
		end_ship_ca.nces_schid ShipToNCESSCHID,
		bill_sold_ca.nces_schid SoldToNCESSCHID,
		--so-621 new mdm attributes addition ends
		--so-661 new attributes addition starts here
			case when bill_sold_ch.buying_customer_flg ='Y' then bill_sold_ch.customer_type_txt 
			else ''
			END BillToAccountType,
			case when end_ship_ch.buying_customer_flg = 'Y' then end_ship_ch.customer_type_txt 
			else ''
			END EndAccountType,
			case when end_ship_ch.buying_customer_flg= 'Y' then end_ship_ch.customer_type_txt 
			else ''
			END ShipToAccountType,
			case when bill_sold_ch.buying_customer_flg= 'Y' then bill_sold_ch.customer_type_txt 
			else '' 
			END SoldToAccountType,
			--SO-661 new attributes addition ends here
		nvl(pcc.attribute_char11,f_c.productcommissionclasscode) as productcommissionclasscode,
		bill_sold_ch.services_major_acc BillToServicesMajorAcc,
		end_ship_ch.services_major_acc EndServicesMajorAcc,
		end_ship_ch.services_major_acc ShipToServicesMajorAcc,
		bill_sold_ch.services_major_acc SoldToServicesMajorAcc,
		bill_sold_ch.customer_sub_class BillToCustomerSubClass,  --so-728 new attributes addition starts
		end_ship_ch.customer_sub_class EndCustomerSubClass,
		end_ship_ch.customer_sub_class ShipToCustomerSubClass,
		bill_sold_ch.customer_sub_class SoldToCustomerSubClass, --so-728 new attributes addition ends 
		cs.serial_number SerialNumber
	FROM
		(select * from @DB_LEVEL@_context_silver.ctx_sales 
		where source = 'USA' 
		and nvl(part_no,'**') not in ('CSHMVECTD','CSHMVEDTC','REBATE-ACP','REBATE-AVCT','VATWHND','BACKCHARGE-MRKTG')) cs---and condition Added by pooja for SKU credit memo exclude 22-06-2022 change SO--699
	LEFT OUTER JOIN @DB_LEVEL@_context_silver.ctx_inventory ci ON
		cs.context_distributor_id = ci.context_distributor_id
		AND cs.sales_series_id = ci.inventory_series_id
	LEFT OUTER JOIN @DB_LEVEL@_context_silver.ctx_channel cc ON
		cs.context_reseller_id = cc.context_id
	LEFT OUTER JOIN @DB_LEVEL@_context_silver.ctx_channel cc_re ON
		cs.context_distributor_id = cc_re.context_id
	LEFT OUTER JOIN	@DB_LEVEL@_cld_cpq_silver.cpq_price_book_associations cpqpb ON
		cs.part_no=cpqpb.part_number and cpqpb.price_book_variable_name='VertivUSCANPriceBook'
	LEFT OUTER JOIN @DB_LEVEL@_context_silver.ctx_channel cc_sh ON
		cs.shipped_to_reseller_id = cc_sh.context_id
	/*New changes for context integration into customer hub START */	
	LEFT OUTER JOIN 
		(SELECT distinct industry_classification_1_txt,industry_classification_2_txt,industry_classification_3_txt,ultimate_parent_txt,customer_name_txt,customer_number,
						 market_sub_vertical_txt,customer_type_txt,market_vertical_txt,city_primary_txt,country_primary_cd,integration_id_join,src_system_name,customer_class_code_txt,
						 partner_class_code_txt,oracle_cloud_registry_id,reporting_sub_parent1,definitive_idn_id,definitive_idn_parentid,nces_leaid,buying_customer_flg,services_major_acc
						  ,customer_sub_class  
				FROM @DB_LEVEL@_mdm_hub_gold.d_customer_header_v where src_system_name like '%CONTEXT%USA%') bill_sold_ch ON 
		cs.context_reseller_id=bill_sold_ch.integration_id_join
    LEFT OUTER JOIN 
		(SELECT distinct site_postal_code_txt,site_address1_txt,site_state_cd,site_country_cd,integration_id_join,src_system_name,
						 site_province_cd,oracle_cloud_party_site_number,definitive_id,nces_schid
				FROM @DB_LEVEL@_mdm_hub_gold.d_customer_address_v where src_system_name like '%CONTEXT%USA%') bill_sold_ca ON
		cs.context_reseller_id=bill_sold_ca.integration_id_join	
	LEFT OUTER JOIN 
		(SELECT distinct industry_classification_1_txt,industry_classification_2_txt,industry_classification_3_txt,ultimate_parent_txt,customer_name_txt,customer_number,
						 market_sub_vertical_txt,customer_type_txt,market_vertical_txt,city_primary_txt,country_primary_cd,integration_id_join,src_system_name,customer_class_code_txt,
						 partner_class_code_txt,oracle_cloud_registry_id,reporting_sub_parent1,definitive_idn_id,definitive_idn_parentid,nces_leaid,buying_customer_flg,services_major_acc
						  ,customer_sub_class  
				FROM @DB_LEVEL@_mdm_hub_gold.d_customer_header_v where src_system_name like '%CONTEXT%USA%') end_ship_ch ON 
		cs.shipped_to_reseller_id=end_ship_ch.integration_id_join
	LEFT OUTER JOIN 
		(SELECT distinct site_postal_code_txt,site_address1_txt,site_state_cd,site_country_cd,integration_id_join,src_system_name
					     site_province_cd,oracle_cloud_party_site_number,definitive_id,nces_schid
				FROM @DB_LEVEL@_mdm_hub_gold.d_customer_address_v where src_system_name like '%CONTEXT%USA%') end_ship_ca ON
		cs.shipped_to_reseller_id=end_ship_ca.integration_id_join	
      left outer join (select * from @DB_LEVEL@_edm_other_src_silver.GPHSKUAssignments where  record_source = 'CONTEXT') gph_sku on 
                   cs.part_no = gph_sku.context_sku 
				   and nvl(gph_sku.context_sku,'**') not in ('CSHMVECTD','CSHMVEDTC','REBATE-ACP','REBATE-AVCT','VATWHND','BACKCHARGE-MRKTG')
				   ---and condition Added by pooja for SKU credit memo exclude change SO--699
	  left outer join (select distinct egp1.item_number, item_eff.attribute_char11 from (
                select * from @DB_LEVEL@_cld_oraerp_silver.egp_system_items_b) egp1
                left outer join @DB_LEVEL@_cld_oraerp_silver.ego_item_eff_b item_eff on
                egp1.inventory_item_id = item_eff.inventory_item_id
                AND egp1.organization_id = item_eff.organization_id
                where item_eff.context_code = 'Business Unit Price Control'
                AND upper(item_eff.acd_type) = 'PROD' and attribute_char1='Vertiv Corp'
                and organization_code='999_ITEM_MASTER')pcc on 
                nvl(cs.part_no,gph_sku.context_sku) = pcc.item_number 
                 and pcc.attribute_char11 is not null	

       LEFT OUTER JOIN
                (
	            SELECT
		        DISTINCT productcommissionclasscode,
		        sku,
		        invoice_number,
		        billtocustomernumber
	        FROM
		       @DB_LEVEL@_edm_gold.f_sales_compensation_hist) f_c ON
	           f_c.sku = nvl(cs.part_no,gph_sku.context_sku)
               and f_c.invoice_number = cs.invoice_number
            and f_c.billtocustomernumber = nvl(bill_sold_ch.customer_number,cs.context_reseller_id)		
			
      --VR 06062022 New changes for SO-683 (CDW fields) starts			   
      LEFT OUTER JOIN @DB_LEVEL@_edm_other_src_silver.CDWMapping cdw ON cs.invoice_number = cdw.invoice_code		
      --VR 06062022 New changes for SO-683 (CDW fields) ends		  
	/*New changes for context integration into customer hub ENDS */
	/*LEFT OUTER JOIN (
		select
			distinct sales_office_name,
			sales_office_num,
			sales_order_num,
			invoice_num,
			invoice_line_type_cd,
			sales_rep_wid,
			product_wid,
			bill_to_customer_account_wid,
			end_customer_account_wid,
			ship_to_customer_account_wid ,
			sold_to_customer_account_wid
		from
			@DB_LEVEL@_edm_gold.f_sales_invoice_line) inv ON
		cs.invoice_number = inv.invoice_num
		and inv.invoice_line_type_cd = 'LINE' */ --commenting the join as need to remove mapping from f_sales_invoice_line
		/*LEFT OUTER JOIN @DB_LEVEL@_edm_gold.d_product_catalog cat ON
		inv.product_wid = cat.product_wid*/
		--commenting the join as need to remove mapping from f_sales_invoice_line
	LEFT OUTER JOIN (
		select
			distinct row_wid,
			part_num,
			product_desc,
			status_cd
		from
			@DB_LEVEL@_edm_gold.d_product) dp ON
		cs.part_no = dp.part_num
		--and dp.status_cd = 'Active'
		--New mapping added for d_product and context table
	LEFT OUTER JOIN (
		select
			distinct product_wid,
			catalog_lvl_desc_1,
			catalog_lvl_desc_6,
			catalog_lvl_desc_2,
			catalog_lvl_desc_4,
			catalog_lvl_desc_5,catalog_lvl_desc_3
		from
			@DB_LEVEL@_edm_gold.d_product_catalog) cat ON
		dp.row_wid = cat.product_wid
		--New mapping added for d_product and d_product_catalog table as f_sales_invoice_line is to be removed.
	/*LEFT OUTER JOIN @DB_LEVEL@_edm_gold.d_sales_rep rep ON
		inv.sales_rep_wid = rep.row_wid */ --commenting the join as  SalesRepID & Name will be blank
		/*LEFT OUTER JOIN (
		SELECT
			row_wid,
			product_desc
		FROM
			@DB_LEVEL@_edm_gold.d_product) prod ON
		inv.product_wid = prod.row_wid */
		/*LEFT OUTER JOIN @DB_LEVEL@_edm_gold.d_customer_account bill_acc ON
		inv.bill_to_customer_account_wid = bill_acc.row_wid*/
		--commenting the join as hashedBillToCustomerName is marked as NULL
		/*LEFT OUTER JOIN @DB_LEVEL@_edm_gold.d_customer_account end_acc ON
		inv.end_customer_account_wid = end_acc.row_wid */
		--commenting the join as hashedEndCustomerName is pulled from ctx_channel.name
		/*LEFT OUTER JOIN @DB_LEVEL@_edm_gold.d_customer_account ship_acc ON
		inv.ship_to_customer_account_wid = ship_acc.row_wid */
		--commenting the join as hashedShipToCustomerName is pulled from ctx_channel.name
		/*LEFT OUTER JOIN @DB_LEVEL@_edm_gold.d_customer_account sold_acc ON
		inv.sold_to_customer_account_wid = sold_acc.row_wid */
		--commenting the join as hashedSoldtoCustomerName is marked as NULL
		/*LEFT OUTER JOIN (
		SELECT
			customername,
			recordsource,
			customertype
		FROM
			(
			SELECT
				*,
				row_number() OVER (PARTITION BY customerid,
				customername,
				recordsource
			ORDER BY
				to_timestamp(date_of_change,
				'dd-MM-yyyy') DESC) rno
			FROM
				@DB_LEVEL@_edm_other_src_silver.customer_data db) p
		WHERE
			p.rno = 1) end_cust ON
		end_acc.account_name = end_cust.customername
		AND end_acc.src_system_name = end_cust.recordsource
		AND end_cust.customertype = 'End' */
		--commenting the join as CustomerName is pulled from ctx_channel.name
		/*LEFT OUTER JOIN (
		SELECT
			DISTINCT office_number,
			office_name,
			office_location,
			office_website,
			sales_area,
			sales_region,
			office_family,
			principal_email,
			principal
		FROM
			@DB_LEVEL@_edm_other_src_silver.rep_office_info) roi ON
		inv.sales_office_name = roi.office_name*/
		--commenting the join as roi fields to be populated later on
) a;


3.Rule1_logic_stg_temp_insert

INSERT INTO @DB_LEVEL@_edm_other_src_silver.pos_na_temp
select 
stg.accountservicesales,
stg.accountsubtype,
stg.accounttype,
stg.activated,
stg.activedate,
stg.assignmentterritory,
stg.billtocustomeraddress,
stg.billtocustomercity,
stg.billtocustomercountry,
stg.billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription,
stg.billtocustomergsc,
stg.billtocustomerid,
stg.billtocustomerindustry,
stg.billtocustomername,
stg.billtocustomernumber,
stg.billtocustomerparentaccount,
stg.billtocustomerparentname,
stg.billtocustomerpostalcode,
stg.billtocustomerreportingname,
stg.billtocustomerstandardizedname,
stg.billtocustomerstate,
stg.billtocustomersubvertical,
stg.billtocustomertype,
stg.billtocustomervertical,
stg.billtoenterpriseindustry,
stg.billtogsc_flag,
stg.billtoindustry,
stg.billtoindustrycode,
stg.billtononrevenueflag,
stg.billtoparentaccount,
stg.billtostandardizedname,
stg.cdwsalesarea,
stg.cdwsalesregion,
stg.cdwsalessegment,
stg.cloudlistprice,
stg.coe,
stg.country,
stg.crossrefwithlesnumber,
stg.currency,
stg.endcustomeraccountrole,
stg.endcustomeraddress,
stg.endcustomercity,
stg.endcustomercountry,
stg.endcustomercustomertype1,
stg.endcustomerenterpriseindustry,
stg.endcustomergscflag,
stg.endcustomerid,
stg.endcustomerindustry1,
stg.endcustomerindustrycode1,
stg.endcustomername,
stg.endcustomerparentaccount,
stg.endcustomerpostalcode,
stg.endcustomerstandardizedname,
stg.endcustomerstate,
stg.endcustomersubvertical,
stg.endcustomervertical,
stg.extendedlistprice,
stg.extendedstandardcost,
stg.gbu,
stg.hashedbilltocustomername,
stg.hashedendcustomername,
stg.hashedshiptocustomername,
stg.hashedsoldtocustomername,
stg.internalofficefamily,
stg.internalofficename,
stg.internalofficenumber,
stg.internalofficeprincipalemail,
stg.internalofficeprincipalname,
stg.internalofficeregion,
stg.internalofficesplit,
stg.internalofficeterritory,
stg.internalofficetype,
stg.internalprincipalemail,
stg.internalprincipalname,
stg.invoicedate,
stg.invoicelinenumber,
stg.invoicenumber,
stg.level6,
stg.listprice,
stg.lob,
stg.multiplier,
stg.namedaccountofficeassign,
stg.namedaccountsplit,
stg.netsalesrevenue,
stg.newlescrossref2,
stg.oemtag,
stg.officelocation,
stg.officetype,
stg.originalsplitpercent,
stg.posprojectregistrationnumber,
stg.possku,
stg.postalcodesofficeassign,
stg.productcategory,
stg.productfamily,
stg.producthierarchylevel1description,
stg.producthierarchylevel2description,
stg.producthierarchylevel3description,
stg.producthierarchylevel4code,
stg.producthierarchylevel4description,
stg.quantityshipped,
stg.recordid,
stg.recordsource,
stg.region,
stg.resellerbranchname,
stg.resellerbranchnumber,
stg.resellermajorcode,
stg.resellerminorcode,
stg.resellername,
stg.resellernumber,
stg.resellerpartnerlevel,
stg.resellerpartnertype,
stg.resellerregion,
stg.resellersalesofficename,
stg.resellersalesofficenumber,
stg.responseid,
stg.sales_area,
stg.salesofficefamily,
IFNULL(cpl.sales_office_name,stg.salesofficename) salesofficename,
--IFNULL(cast(cpl.sales_office_number as STRING),stg.salesofficenumber) salesofficenumber,
case when length (cast(cpl.sales_office_number as STRING))<5 then lpad(cast(cpl.sales_office_number as STRING),5,'0')
else IFNULL(cast(cpl.sales_office_number as STRING),stg.salesofficenumber) end as salesofficenumber,
stg.salesofficenumber2,
stg.salesofficeprincipalemail,
stg.salesofficeprincipalname,
IFNULL(cpl.region,stg.salesofficeregion) salesofficeregion,
stg.salesofficeterritory,
stg.salesordernumber,
stg.salesoutprimarykey,
stg.salesregion,
stg.salesregion2,
stg.salesrepemail,
stg.salesrepid,
stg.salesrepname,
stg.segment,
stg.shiptocustomeraddress,
stg.shiptocustomercity,
stg.shiptocustomercountry,
stg.shiptocustomerenterpriseindustry,
stg.shiptocustomergsc,
stg.shiptocustomerid,
stg.shiptocustomerindustry1,
stg.shiptocustomername,
stg.shiptocustomernumber,
stg.shiptocustomerparentaccount,
stg.shiptocustomerparentname,
stg.shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname,
stg.shiptocustomerstate,
stg.shiptocustomersubvertical,
stg.shiptocustomertype1,
stg.shiptocustomertype1_2,
stg.shiptocustomervertical,
stg.shiptoenterpriseindustry,
stg.shiptogsc_flag,
stg.shiptoindustry1,
stg.shiptoparentaccount,
stg.shiptostandardizedname,
stg.sizecategory,
stg.sku,
stg.skudescription,
stg.soldtocustomeraddress,
stg.soldtocustomercity,
stg.soldtocustomercountry,
stg.soldtocustomercustomergsc,
stg.soldtocustomercustomertype1,
stg.soldtocustomerindustry1,
stg.soldtocustomername,
stg.soldtocustomernumber,
stg.soldtocustomerparentaccount,
stg.soldtocustomerpostalcode,
stg.soldtocustomerstate,
stg.soldtocustomersubvertical,
stg.soldtocustomervertical,
stg.sp1productflag,
stg.sp1targetaccountflag,
stg.sp2productflag,
stg.sp2targetaccountflag,
stg.speed_dial,
stg.splitpercent,
stg.standard_products,
stg.standardcost,
stg.transactionamount,
stg.transactiontype,
stg.yearmonth,
stg.intrachannelflag,
stg.w_insert_dtm,
stg.endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode,
stg.endcustomerclasscode,
stg.shiptocustomerclasscode,
stg.soldtocustomerclasscode,
stg.billtocustomerpartnerclasscode,
stg.endcustomerpartnerclasscode,
stg.shiptocustomerpartnerclasscode,
stg.soldtocustomerpartnerclasscode,
stg.billtooracleregistryid, 
stg.endoracleregistryid,
stg.shiptooracleregistryid,
stg.soldtooracleregistryid,
stg.billtocustomerindustry1,
stg.billtocustomerindustry3,
stg.endcustomerindustry3,
stg.shiptocustomerindustry3,
stg.soldtocustomerindustry3,
stg.billtoreportingsubparent1,
stg.endreportingsubparent1,
stg.shiptoreportingsubparent1,
stg.soldtoreportingsubparent1,
stg.billtodefinitiveidnid,
stg.enddefinitiveidnid,
stg.shiptodefinitiveidnid,
stg.soldtodefinitiveidnid,
stg.billtodefinitiveidnidparentid,
stg.enddefinitiveidnidparentid,
stg.shiptodefinitiveidnidparentid,
stg.soldtodefinitiveidnidparentid,
stg.billtoncesleaid,
stg.endncesleaid,
stg.shiptoncesleaid,
stg.soldtoncesleaid,
stg.billtocustomerprovince,
stg.endcustomerprovince,
stg.shiptocustomerprovince,
stg.soldtocustomerprovince,
stg.billtooraclepartysitenumber,  
stg.endoraclepartysitenumber,
stg.shiptooraclepartysitenumber,
stg.soldtooraclepartysitenumber,
stg.billtodefinitiveid,
stg.enddefinitiveid,
stg.shiptodefinitiveid,
stg.soldtodefinitiveid,
stg.billtoncesschid,
stg.endncesschid,
stg.shiptoncesschid,
stg.soldtoncesschid,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype,
stg.endaccounttype,
stg.shiptoaccounttype,
stg.soldtoaccounttype,
--so-661 new attributes addition ends
productcommissionclasscode,
stg.billtoservicesmajoracc, --so-665 new attributes addition starts
stg.endservicesmajoracc,
stg.shiptoservicesmajoracc,
stg.soldtoservicesmajoracc,  --so-665 new attributes addition ends
stg.billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass,
stg.shiptocustomersubclass,
stg.soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg left outer join
@DB_LEVEL@_edm_other_src_silver.canada_pos_cd_lst cpl on
--STRLEFT(stg.EndCustomerPostalCode,3)=cpl.zip_code
stg.EndCustomerPostalCode=cpl.zip_code
and stg.endcustomercountry='Canada' ;

invalidate metadata @DB_LEVEL@_edm_other_src_silver.pos_na_temp;


truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_stg;

insert into @DB_LEVEL@_edm_other_src_silver.pos_na_stg
select * from @DB_LEVEL@_edm_other_src_silver.pos_na_temp;

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_temp;


4.Rule2_logic_stg_temp_insert

INSERT INTO @DB_LEVEL@_edm_other_src_silver.pos_na_temp
select 
stg.accountservicesales,
stg.accountsubtype,
stg.accounttype,
stg.activated,
stg.activedate,
stg.assignmentterritory,
stg.billtocustomeraddress,
stg.billtocustomercity,
stg.billtocustomercountry,
stg.billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription,
stg.billtocustomergsc,
stg.billtocustomerid,
stg.billtocustomerindustry,
stg.billtocustomername,
stg.billtocustomernumber,
stg.billtocustomerparentaccount,
stg.billtocustomerparentname,
stg.billtocustomerpostalcode,
stg.billtocustomerreportingname,
stg.billtocustomerstandardizedname,
stg.billtocustomerstate,
stg.billtocustomersubvertical,
stg.billtocustomertype,
stg.billtocustomervertical,
stg.billtoenterpriseindustry,
stg.billtogsc_flag,
stg.billtoindustry,
stg.billtoindustrycode,
stg.billtononrevenueflag,
stg.billtoparentaccount,
stg.billtostandardizedname,
stg.cdwsalesarea,
stg.cdwsalesregion,
stg.cdwsalessegment,
stg.cloudlistprice,
stg.coe,
stg.country,
stg.crossrefwithlesnumber,
stg.currency,
stg.endcustomeraccountrole,
stg.endcustomeraddress,
stg.endcustomercity,
stg.endcustomercountry,
stg.endcustomercustomertype1,
stg.endcustomerenterpriseindustry,
stg.endcustomergscflag,
stg.endcustomerid,
stg.endcustomerindustry1,
stg.endcustomerindustrycode1,
stg.endcustomername,
stg.endcustomerparentaccount,
stg.endcustomerpostalcode,
stg.endcustomerstandardizedname,
stg.endcustomerstate,
stg.endcustomersubvertical,
stg.endcustomervertical,
stg.extendedlistprice,
stg.extendedstandardcost,
stg.gbu,
stg.hashedbilltocustomername,
stg.hashedendcustomername,
stg.hashedshiptocustomername,
stg.hashedsoldtocustomername,
stg.internalofficefamily,
stg.internalofficename,
stg.internalofficenumber,
stg.internalofficeprincipalemail,
stg.internalofficeprincipalname,
stg.internalofficeregion,
stg.internalofficesplit,
stg.internalofficeterritory,
stg.internalofficetype,
stg.internalprincipalemail,
stg.internalprincipalname,
stg.invoicedate,
stg.invoicelinenumber,
stg.invoicenumber,
stg.level6,
stg.listprice,
stg.lob,
stg.multiplier,
stg.namedaccountofficeassign,
stg.namedaccountsplit,
stg.netsalesrevenue,
stg.newlescrossref2,
stg.oemtag,
stg.officelocation,
stg.officetype,
stg.originalsplitpercent,
stg.posprojectregistrationnumber,
stg.possku,
stg.postalcodesofficeassign,
stg.productcategory,
stg.productfamily,
stg.producthierarchylevel1description,
stg.producthierarchylevel2description,
stg.producthierarchylevel3description,
stg.producthierarchylevel4code,
stg.producthierarchylevel4description,
stg.quantityshipped,
stg.recordid,
stg.recordsource,
stg.region,
stg.resellerbranchname,
stg.resellerbranchnumber,
stg.resellermajorcode,
stg.resellerminorcode,
stg.resellername,
stg.resellernumber,
stg.resellerpartnerlevel,
stg.resellerpartnertype,
stg.resellerregion,
stg.resellersalesofficename,
stg.resellersalesofficenumber,
stg.responseid,
stg.sales_area,
stg.salesofficefamily,
IFNULL(upl.office_name,stg.salesofficename) salesofficename,
--IFNULL( cast(upl.office_number as string ),stg.salesofficenumber) salesofficenumber,
case when length (cast(upl.office_number as STRING))<5 then lpad(cast(upl.office_number as STRING),5,'0')
else IFNULL(cast(upl.office_number as STRING),stg.salesofficenumber) end as salesofficenumber,
stg.salesofficenumber2,
stg.salesofficeprincipalemail,
stg.salesofficeprincipalname,
IFNULL(upl.sales_region,stg.salesofficeregion) salesofficeregion,
stg.salesofficeterritory,
stg.salesordernumber,
stg.salesoutprimarykey,
stg.salesregion,
stg.salesregion2,
stg.salesrepemail,
stg.salesrepid,
stg.salesrepname,
stg.segment,
stg.shiptocustomeraddress,
stg.shiptocustomercity,
stg.shiptocustomercountry,
stg.shiptocustomerenterpriseindustry,
stg.shiptocustomergsc,
stg.shiptocustomerid,
stg.shiptocustomerindustry1,
stg.shiptocustomername,
stg.shiptocustomernumber,
stg.shiptocustomerparentaccount,
stg.shiptocustomerparentname,
stg.shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname,
stg.shiptocustomerstate,
stg.shiptocustomersubvertical,
stg.shiptocustomertype1,
stg.shiptocustomertype1_2,
stg.shiptocustomervertical,
stg.shiptoenterpriseindustry,
stg.shiptogsc_flag,
stg.shiptoindustry1,
stg.shiptoparentaccount,
stg.shiptostandardizedname,
stg.sizecategory,
stg.sku,
stg.skudescription,
stg.soldtocustomeraddress,
stg.soldtocustomercity,
stg.soldtocustomercountry,
stg.soldtocustomercustomergsc,
stg.soldtocustomercustomertype1,
stg.soldtocustomerindustry1,
stg.soldtocustomername,
stg.soldtocustomernumber,
stg.soldtocustomerparentaccount,
stg.soldtocustomerpostalcode,
stg.soldtocustomerstate,
stg.soldtocustomersubvertical,
stg.soldtocustomervertical,
stg.sp1productflag,
stg.sp1targetaccountflag,
stg.sp2productflag,
stg.sp2targetaccountflag,
stg.speed_dial,
stg.splitpercent,
stg.standard_products,
stg.standardcost,
stg.transactionamount,
stg.transactiontype,
stg.yearmonth,
stg.intrachannelflag,
stg.w_insert_dtm,
stg.endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode,
stg.endcustomerclasscode,
stg.shiptocustomerclasscode,
stg.soldtocustomerclasscode,
stg.billtocustomerpartnerclasscode,
stg.endcustomerpartnerclasscode,
stg.shiptocustomerpartnerclasscode,
stg.soldtocustomerpartnerclasscode,
stg.billtooracleregistryid, 
stg.endoracleregistryid,
stg.shiptooracleregistryid,
stg.soldtooracleregistryid,
stg.billtocustomerindustry1,
stg.billtocustomerindustry3,
stg.endcustomerindustry3,
stg.shiptocustomerindustry3,
stg.soldtocustomerindustry3,
stg.billtoreportingsubparent1,
stg.endreportingsubparent1,
stg.shiptoreportingsubparent1,
stg.soldtoreportingsubparent1,
stg.billtodefinitiveidnid,
stg.enddefinitiveidnid,
stg.shiptodefinitiveidnid,
stg.soldtodefinitiveidnid,
stg.billtodefinitiveidnidparentid,
stg.enddefinitiveidnidparentid,
stg.shiptodefinitiveidnidparentid,
stg.soldtodefinitiveidnidparentid,
stg.billtoncesleaid,
stg.endncesleaid,
stg.shiptoncesleaid,
stg.soldtoncesleaid,
stg.billtocustomerprovince,
stg.endcustomerprovince,
stg.shiptocustomerprovince,
stg.soldtocustomerprovince,
stg.billtooraclepartysitenumber,  
stg.endoraclepartysitenumber,
stg.shiptooraclepartysitenumber,
stg.soldtooraclepartysitenumber,
stg.billtodefinitiveid,
stg.enddefinitiveid,
stg.shiptodefinitiveid,
stg.soldtodefinitiveid,
stg.billtoncesschid,
stg.endncesschid,
stg.shiptoncesschid,
stg.soldtoncesschid,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype,
stg.endaccounttype,
stg.shiptoaccounttype,
stg.soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode,
stg.billtoservicesmajoracc, --so-665 new attributes addition starts
stg.endservicesmajoracc,
stg.shiptoservicesmajoracc,
stg.soldtoservicesmajoracc,  --so-665 new attributes addition ends
stg.billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass,
stg.shiptocustomersubclass,
stg.soldtocustomersubclass,  --so-728 new attributes addition ends,
stg.serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg left outer join
@DB_LEVEL@_edm_other_src_silver.usa_pos_cd_lst upl on
--STRLEFT(SUBSTRING(stg.EndCustomerPostalCode,4),5)=cast(upl.zip_code as string)
stg.EndCustomerPostalCode=cast(upl.zip_code as string)
and stg.endcustomercountry='United States'
;

invalidate metadata @DB_LEVEL@_edm_other_src_silver.pos_na_temp;


truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_stg;

insert into @DB_LEVEL@_edm_other_src_silver.pos_na_stg
select 
pnt.accountservicesales,
pnt.accountsubtype,
pnt.accounttype,
pnt.activated,
pnt.activedate,
pnt.assignmentterritory,
pnt.billtocustomeraddress,
pnt.billtocustomercity,
pnt.billtocustomercountry,
pnt.billtocustomerenterpriseindustry,
pnt.billtocustomergicsinudstrygroupdescription,
pnt.billtocustomergicssectordescription,
pnt.billtocustomergsc,
pnt.billtocustomerid,
pnt.billtocustomerindustry,
pnt.billtocustomername,
pnt.billtocustomernumber,
pnt.billtocustomerparentaccount,
pnt.billtocustomerparentname,
pnt.billtocustomerpostalcode,
pnt.billtocustomerreportingname,
pnt.billtocustomerstandardizedname,
pnt.billtocustomerstate,
pnt.billtocustomersubvertical,
pnt.billtocustomertype,
pnt.billtocustomervertical,
pnt.billtoenterpriseindustry,
pnt.billtogsc_flag,
pnt.billtoindustry,
pnt.billtoindustrycode,
pnt.billtononrevenueflag,
pnt.billtoparentaccount,
pnt.billtostandardizedname,
pnt.cdwsalesarea,
pnt.cdwsalesregion,
pnt.cdwsalessegment,
pnt.cloudlistprice,
pnt.coe,
pnt.country,
pnt.crossrefwithlesnumber,
pnt.currency,
pnt.endcustomeraccountrole,
pnt.endcustomeraddress,
pnt.endcustomercity,
pnt.endcustomercountry,
pnt.endcustomercustomertype1,
pnt.endcustomerenterpriseindustry,
pnt.endcustomergscflag,
pnt.endcustomerid,
pnt.endcustomerindustry1,
pnt.endcustomerindustrycode1,
pnt.endcustomername,
pnt.endcustomerparentaccount,
pnt.endcustomerpostalcode,
pnt.endcustomerstandardizedname,
pnt.endcustomerstate,
pnt.endcustomersubvertical,
pnt.endcustomervertical,
pnt.extendedlistprice,
pnt.extendedstandardcost,
pnt.gbu,
pnt.hashedbilltocustomername,
pnt.hashedendcustomername,
pnt.hashedshiptocustomername,
pnt.hashedsoldtocustomername,
pnt.internalofficefamily,
pnt.internalofficename,
pnt.internalofficenumber,
pnt.internalofficeprincipalemail,
pnt.internalofficeprincipalname,
pnt.internalofficeregion,
pnt.internalofficesplit,
pnt.internalofficeterritory,
pnt.internalofficetype,
pnt.internalprincipalemail,
pnt.internalprincipalname,
pnt.invoicedate,
pnt.invoicelinenumber,
pnt.invoicenumber,
pnt.level6,
pnt.listprice,
pnt.lob,
pnt.multiplier,
pnt.namedaccountofficeassign,
pnt.namedaccountsplit,
pnt.netsalesrevenue,
pnt.newlescrossref2,
pnt.oemtag,
pnt.officelocation,
pnt.officetype,
pnt.originalsplitpercent,
pnt.posprojectregistrationnumber,
pnt.possku,
pnt.postalcodesofficeassign,
pnt.productcategory,
pnt.productfamily,
pnt.producthierarchylevel1description,
pnt.producthierarchylevel2description,
pnt.producthierarchylevel3description,
pnt.producthierarchylevel4code,
pnt.producthierarchylevel4description,
pnt.quantityshipped,
pnt.recordid,
pnt.recordsource,
pnt.region,
pnt.resellerbranchname,
pnt.resellerbranchnumber,
pnt.resellermajorcode,
pnt.resellerminorcode,
pnt.resellername,
pnt.resellernumber,
pnt.resellerpartnerlevel,
pnt.resellerpartnertype,
pnt.resellerregion,
pnt.resellersalesofficename,
pnt.resellersalesofficenumber,
pnt.responseid,
pnt.sales_area,
IFNULL(roi.office_family,pnt.salesofficefamily) salesofficefamily,   
IFNULL(roi.office_name,pnt.salesofficename)  salesofficename,
pnt.salesofficenumber,
pnt.salesofficenumber2,
IFNULL(roi.principal_email,pnt.salesofficeprincipalemail) salesofficeprincipalemail, 
IFNULL(roi.principal,pnt.salesofficeprincipalname) salesofficeprincipalname, 
IFNULL((decode(roi.country,'USA',replace(roi.sales_region,'Midwest','US - Midwest'),roi.sales_region )),pnt.salesofficeregion)  salesofficeregion,  
IFNULL((decode(roi.country,'USA',replace(roi.sales_region,'Midwest','US - Midwest'),roi.sales_region )),pnt.salesofficeterritory)  salesofficeterritory, 
pnt.salesordernumber,
pnt.salesoutprimarykey,
IFNULL((decode(roi.country,'USA',replace(roi.sales_region,'Midwest','US - Midwest'),roi.sales_region )),pnt.salesregion) salesregion, 
pnt.salesregion2,
pnt.salesrepemail,
pnt.salesrepid,
pnt.salesrepname,
pnt.segment,
pnt.shiptocustomeraddress,
pnt.shiptocustomercity,
pnt.shiptocustomercountry,
pnt.shiptocustomerenterpriseindustry,
pnt.shiptocustomergsc,
pnt.shiptocustomerid,
pnt.shiptocustomerindustry1,
pnt.shiptocustomername,
pnt.shiptocustomernumber,
pnt.shiptocustomerparentaccount,
pnt.shiptocustomerparentname,
pnt.shiptocustomerpostalcode,
pnt.shiptocustomerstandardizedname,
pnt.shiptocustomerstate,
pnt.shiptocustomersubvertical,
pnt.shiptocustomertype1,
pnt.shiptocustomertype1_2,
pnt.shiptocustomervertical,
pnt.shiptoenterpriseindustry,
pnt.shiptogsc_flag,
pnt.shiptoindustry1,
pnt.shiptoparentaccount,
pnt.shiptostandardizedname,
pnt.sizecategory,
pnt.sku,
pnt.skudescription,
pnt.soldtocustomeraddress,
pnt.soldtocustomercity,
pnt.soldtocustomercountry,
pnt.soldtocustomercustomergsc,
pnt.soldtocustomercustomertype1,
pnt.soldtocustomerindustry1,
pnt.soldtocustomername,
pnt.soldtocustomernumber,
pnt.soldtocustomerparentaccount,
pnt.soldtocustomerpostalcode,
pnt.soldtocustomerstate,
pnt.soldtocustomersubvertical,
pnt.soldtocustomervertical,
pnt.sp1productflag,
pnt.sp1targetaccountflag,
pnt.sp2productflag,
pnt.sp2targetaccountflag,
pnt.speed_dial,
pnt.splitpercent,
pnt.standardcost,
pnt.standard_products,
pnt.transactionamount,
pnt.transactiontype,
pnt.yearmonth,
pnt.intrachannelflag,
pnt.w_insert_dtm,
pnt.endcustomernumber,
--so-621 new attributes addition
pnt.billtocustomerclasscode,
pnt.endcustomerclasscode,
pnt.shiptocustomerclasscode,
pnt.soldtocustomerclasscode,
pnt.billtocustomerpartnerclasscode,
pnt.endcustomerpartnerclasscode,
pnt.shiptocustomerpartnerclasscode,
pnt.soldtocustomerpartnerclasscode,
pnt.billtooracleregistryid, 
pnt.endoracleregistryid,
pnt.shiptooracleregistryid,
pnt.soldtooracleregistryid,
pnt.billtocustomerindustry1,
pnt.billtocustomerindustry3,
pnt.endcustomerindustry3,
pnt.shiptocustomerindustry3,
pnt.soldtocustomerindustry3,
pnt.billtoreportingsubparent1,
pnt.endreportingsubparent1,
pnt.shiptoreportingsubparent1,
pnt.soldtoreportingsubparent1,
pnt.billtodefinitiveidnid,
pnt.enddefinitiveidnid,
pnt.shiptodefinitiveidnid,
pnt.soldtodefinitiveidnid,
pnt.billtodefinitiveidnidparentid,
pnt.enddefinitiveidnidparentid,
pnt.shiptodefinitiveidnidparentid,
pnt.soldtodefinitiveidnidparentid,
pnt.billtoncesleaid,
pnt.endncesleaid,
pnt.shiptoncesleaid,
pnt.soldtoncesleaid,
pnt.billtocustomerprovince,
pnt.endcustomerprovince,
pnt.shiptocustomerprovince,
pnt.soldtocustomerprovince,
pnt.billtooraclepartysitenumber,  
pnt.endoraclepartysitenumber,
pnt.shiptooraclepartysitenumber,
pnt.soldtooraclepartysitenumber,
pnt.billtodefinitiveid,
pnt.enddefinitiveid,
pnt.shiptodefinitiveid,
pnt.soldtodefinitiveid,
pnt.billtoncesschid,
pnt.endncesschid,
pnt.shiptoncesschid,
pnt.soldtoncesschid,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
pnt.billtoaccounttype,
pnt.endaccounttype,
pnt.shiptoaccounttype,
pnt.soldtoaccounttype,
--so-661 new attributes addition ends
pnt.productcommissionclasscode,
pnt.billtoservicesmajoracc, --so-665 new attributes addition starts
pnt.endservicesmajoracc,
pnt.shiptoservicesmajoracc,
pnt.soldtoservicesmajoracc,  --so-665 new attributes addition ends
pnt.billtocustomersubclass, --so-728 new attributes addition starts
pnt.endcustomersubclass,
pnt.shiptocustomersubclass,
pnt.soldtocustomersubclass,  --so-728 new attributes addition ends
pnt.serialnumber
from 
@DB_LEVEL@_edm_other_src_silver.pos_na_temp pnt
left outer join @DB_LEVEL@_edm_other_src_silver.rep_office_info roi
on pnt.salesofficenumber =roi.office_location;

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_temp;


5.Rule3_stg_to_temp

INSERT INTO @DB_LEVEL@_edm_other_src_silver.pos_na_temp
(
accountservicesales,
accountsubtype,
accounttype,
activated,
activedate,
assignmentterritory,
billtocustomeraddress,
billtocustomercity,
billtocustomercountry,
billtocustomerenterpriseindustry,
billtocustomergicsinudstrygroupdescription,
billtocustomergicssectordescription,
billtocustomergsc,
billtocustomerid,
billtocustomerindustry,
billtocustomername,
billtocustomernumber,
billtocustomerparentaccount,
billtocustomerparentname,
billtocustomerpostalcode,
billtocustomerreportingname,
billtocustomerstandardizedname,
billtocustomerstate,
billtocustomersubvertical,
billtocustomertype,
billtocustomervertical,
billtoenterpriseindustry,
billtogsc_flag,
billtoindustry,
billtoindustrycode,
billtononrevenueflag,
billtoparentaccount,
billtostandardizedname,
cdwsalesarea,
cdwsalesregion,
cdwsalessegment,
cloudlistprice,
coe,
country,
crossrefwithlesnumber,
currency,
endcustomeraccountrole,
endcustomeraddress,
endcustomercity,
endcustomercountry,
endcustomercustomertype1,
endcustomerenterpriseindustry,
endcustomergscflag,
endcustomerid,
endcustomerindustry1,
endcustomerindustrycode1,
endcustomername,
endcustomerparentaccount,
endcustomerpostalcode,
endcustomerstandardizedname,
endcustomerstate,
endcustomersubvertical,
endcustomervertical,
extendedlistprice,
extendedstandardcost,
gbu,
hashedbilltocustomername,
hashedendcustomername,
hashedshiptocustomername,
hashedsoldtocustomername,
internalofficefamily,
internalofficename,
internalofficenumber,
internalofficeprincipalemail,
internalofficeprincipalname,
internalofficeregion,
internalofficesplit,
internalofficeterritory,
internalofficetype,
internalprincipalemail,
internalprincipalname,
invoicedate,
invoicelinenumber,
invoicenumber,
level6,
listprice,
lob,
multiplier,
namedaccountofficeassign,
namedaccountsplit,
netsalesrevenue,
newlescrossref2,
oemtag,
officelocation,
officetype,
originalsplitpercent,
posprojectregistrationnumber,
possku,
postalcodesofficeassign,
productcategory,
productfamily,
producthierarchylevel1description,
producthierarchylevel2description,
producthierarchylevel3description,
producthierarchylevel4code,
producthierarchylevel4description,
quantityshipped,
recordid,
recordsource,
region,
resellerbranchname,
resellerbranchnumber,
resellermajorcode,
resellerminorcode,
resellername,
resellernumber,
resellerpartnerlevel,
resellerpartnertype,
resellerregion,
resellersalesofficename,
resellersalesofficenumber,
responseid,
sales_area,
salesofficefamily,
salesofficename,
salesofficenumber,
salesofficenumber2,
salesofficeprincipalemail,
salesofficeprincipalname,
salesofficeregion,
salesofficeterritory,
salesordernumber,
salesoutprimarykey,
salesregion,
salesregion2,
salesrepemail,
salesrepid,
salesrepname,
segment,
shiptocustomeraddress,
shiptocustomercity,
shiptocustomercountry,
shiptocustomerenterpriseindustry,
shiptocustomergsc,
shiptocustomerid,
shiptocustomerindustry1,
shiptocustomername,
shiptocustomernumber,
shiptocustomerparentaccount,
shiptocustomerparentname,
shiptocustomerpostalcode,
shiptocustomerstandardizedname,
shiptocustomerstate,
shiptocustomersubvertical,
shiptocustomertype1,
shiptocustomertype1_2,
shiptocustomervertical,
shiptoenterpriseindustry,
shiptogsc_flag,
shiptoindustry1,
shiptoparentaccount,
shiptostandardizedname,
sizecategory,
sku,
skudescription,
soldtocustomeraddress,
soldtocustomercity,
soldtocustomercountry,
soldtocustomercustomergsc,
soldtocustomercustomertype1,
soldtocustomerindustry1,
soldtocustomername,
soldtocustomernumber,
soldtocustomerparentaccount,
soldtocustomerpostalcode,
soldtocustomerstate,
soldtocustomersubvertical,
soldtocustomervertical,
sp1productflag,
sp1targetaccountflag,
sp2productflag,
sp2targetaccountflag,
speed_dial,
splitpercent,
standard_products,
standardcost,
transactionamount,
transactiontype,
yearmonth,
intrachannelflag,
w_insert_dtm,
endcustomernumber,
billtocustomerclasscode, --so-621 new attributes addition
endcustomerclasscode,
shiptocustomerclasscode,
soldtocustomerclasscode,
billtocustomerpartnerclasscode,
endcustomerpartnerclasscode,
shiptocustomerpartnerclasscode,
soldtocustomerpartnerclasscode,
billtooracleregistryid, 
endoracleregistryid,
shiptooracleregistryid,
soldtooracleregistryid,
billtocustomerindustry1,
billtocustomerindustry3,
endcustomerindustry3,
shiptocustomerindustry3,
soldtocustomerindustry3,
billtoreportingsubparent1,
endreportingsubparent1,
shiptoreportingsubparent1,
soldtoreportingsubparent1,
billtodefinitiveidnid,
enddefinitiveidnid,
shiptodefinitiveidnid,
soldtodefinitiveidnid,
billtodefinitiveidnidparentid,
enddefinitiveidnidparentid,
shiptodefinitiveidnidparentid,
soldtodefinitiveidnidparentid,
billtoncesleaid,
endncesleaid,
shiptoncesleaid,
soldtoncesleaid,
billtocustomerprovince,
endcustomerprovince,
shiptocustomerprovince,
soldtocustomerprovince,
billtooraclepartysitenumber,  
endoraclepartysitenumber,
shiptooraclepartysitenumber,
soldtooraclepartysitenumber,
billtodefinitiveid,
enddefinitiveid,
shiptodefinitiveid,
soldtodefinitiveid,
billtoncesschid,
endncesschid,
shiptoncesschid,
soldtoncesschid, --so-621 new attributes addition ends
billtoaccounttype, --so-661 new attributes addition starts
endaccounttype,
shiptoaccounttype,
soldtoaccounttype, --so-661 new attributes addition ends
productcommissionclasscode,
billtoservicesmajoracc,  --so-665 new attributes addition starts
endservicesmajoracc,
shiptoservicesmajoracc,
soldtoservicesmajoracc,   --so-665 new attributes addition ends
billtocustomersubclass, --so-728 new attributes addition starts
endcustomersubclass,
shiptocustomersubclass,
soldtocustomersubclass,  --so-728 new attributes addition ends
serialnumber
)
select
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
stg.originalsplitpercent as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
stg.salesofficenumber as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
case when stg.productfamily = pf.product_family and pf.standard_product = 'SP1' then 'TRUE'
else 'FALSE'
end as sp1productflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
case when stg.productfamily = pf.product_family and pf.standard_product = 'SP2' then 'TRUE'
else 'FALSE'
end as sp2productflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
stg.splitpercent as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag,
stg.w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
left outer join @DB_LEVEL@_edm_other_src_silver.product_family_classification pf
on stg.productfamily = pf.product_family ;


6.Rule3_temp_to_stg

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_stg ;

insert into @DB_LEVEL@_edm_other_src_silver.pos_na_stg
select * from @DB_LEVEL@_edm_other_src_silver.pos_na_temp ;


7.Rule4_stg_to_temp

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_temp ;

INSERT INTO @DB_LEVEL@_edm_other_src_silver.pos_na_temp
(
accountservicesales,
accountsubtype,
accounttype,
activated,
activedate,
assignmentterritory,
billtocustomeraddress,
billtocustomercity,
billtocustomercountry,
billtocustomerenterpriseindustry,
billtocustomergicsinudstrygroupdescription,
billtocustomergicssectordescription,
billtocustomergsc,
billtocustomerid,
billtocustomerindustry,
billtocustomername,
billtocustomernumber,
billtocustomerparentaccount,
billtocustomerparentname,
billtocustomerpostalcode,
billtocustomerreportingname,
billtocustomerstandardizedname,
billtocustomerstate,
billtocustomersubvertical,
billtocustomertype,
billtocustomervertical,
billtoenterpriseindustry,
billtogsc_flag,
billtoindustry,
billtoindustrycode,
billtononrevenueflag,
billtoparentaccount,
billtostandardizedname,
cdwsalesarea,
cdwsalesregion,
cdwsalessegment,
cloudlistprice,
coe,
country,
crossrefwithlesnumber,
currency,
endcustomeraccountrole,
endcustomeraddress,
endcustomercity,
endcustomercountry,
endcustomercustomertype1,
endcustomerenterpriseindustry,
endcustomergscflag,
endcustomerid,
endcustomerindustry1,
endcustomerindustrycode1,
endcustomername,
endcustomerparentaccount,
endcustomerpostalcode,
endcustomerstandardizedname,
endcustomerstate,
endcustomersubvertical,
endcustomervertical,
extendedlistprice,
extendedstandardcost,
gbu,
hashedbilltocustomername,
hashedendcustomername,
hashedshiptocustomername,
hashedsoldtocustomername,
internalofficefamily,
internalofficename,
internalofficenumber,
internalofficeprincipalemail,
internalofficeprincipalname,
internalofficeregion,
internalofficesplit,
internalofficeterritory,
internalofficetype,
internalprincipalemail,
internalprincipalname,
invoicedate,
invoicelinenumber,
invoicenumber,
level6,
listprice,
lob,
multiplier,
namedaccountofficeassign,
namedaccountsplit,
netsalesrevenue,
newlescrossref2,
oemtag,
officelocation,
officetype,
originalsplitpercent,
posprojectregistrationnumber,
possku,
postalcodesofficeassign,
productcategory,
productfamily,
producthierarchylevel1description,
producthierarchylevel2description,
producthierarchylevel3description,
producthierarchylevel4code,
producthierarchylevel4description,
quantityshipped,
recordid,
recordsource,
region,
resellerbranchname,
resellerbranchnumber,
resellermajorcode,
resellerminorcode,
resellername,
resellernumber,
resellerpartnerlevel,
resellerpartnertype,
resellerregion,
resellersalesofficename,
resellersalesofficenumber,
responseid,
sales_area,
salesofficefamily,
salesofficename,
salesofficenumber,
salesofficenumber2,
salesofficeprincipalemail,
salesofficeprincipalname,
salesofficeregion,
salesofficeterritory,
salesordernumber,
salesoutprimarykey,
salesregion,
salesregion2,
salesrepemail,
salesrepid,
salesrepname,
segment,
shiptocustomeraddress,
shiptocustomercity,
shiptocustomercountry,
shiptocustomerenterpriseindustry,
shiptocustomergsc,
shiptocustomerid,
shiptocustomerindustry1,
shiptocustomername,
shiptocustomernumber,
shiptocustomerparentaccount,
shiptocustomerparentname,
shiptocustomerpostalcode,
shiptocustomerstandardizedname,
shiptocustomerstate,
shiptocustomersubvertical,
shiptocustomertype1,
shiptocustomertype1_2,
shiptocustomervertical,
shiptoenterpriseindustry,
shiptogsc_flag,
shiptoindustry1,
shiptoparentaccount,
shiptostandardizedname,
sizecategory,
sku,
skudescription,
soldtocustomeraddress,
soldtocustomercity,
soldtocustomercountry,
soldtocustomercustomergsc,
soldtocustomercustomertype1,
soldtocustomerindustry1,
soldtocustomername,
soldtocustomernumber,
soldtocustomerparentaccount,
soldtocustomerpostalcode,
soldtocustomerstate,
soldtocustomersubvertical,
soldtocustomervertical,
sp1productflag,
sp1targetaccountflag,
sp2productflag,
sp2targetaccountflag,
speed_dial,
splitpercent,
standard_products,
standardcost,
transactionamount,
transactiontype,
yearmonth,
intrachannelflag,
w_insert_dtm,
endcustomernumber,
--so-621 new attributes addition
billtocustomerclasscode,
endcustomerclasscode,
shiptocustomerclasscode,
soldtocustomerclasscode,
billtocustomerpartnerclasscode,
endcustomerpartnerclasscode,
shiptocustomerpartnerclasscode,
soldtocustomerpartnerclasscode,
billtooracleregistryid, 
endoracleregistryid,
shiptooracleregistryid,
soldtooracleregistryid,
billtocustomerindustry1,
billtocustomerindustry3,
endcustomerindustry3,
shiptocustomerindustry3,
soldtocustomerindustry3,
billtoreportingsubparent1,
endreportingsubparent1,
shiptoreportingsubparent1,
soldtoreportingsubparent1,
billtodefinitiveidnid,
enddefinitiveidnid,
shiptodefinitiveidnid,
soldtodefinitiveidnid,
billtodefinitiveidnidparentid,
enddefinitiveidnidparentid,
shiptodefinitiveidnidparentid,
soldtodefinitiveidnidparentid,
billtoncesleaid,
endncesleaid,
shiptoncesleaid,
soldtoncesleaid,
billtocustomerprovince,
endcustomerprovince,
shiptocustomerprovince,
soldtocustomerprovince,
billtooraclepartysitenumber,  
endoraclepartysitenumber,
shiptooraclepartysitenumber,
soldtooraclepartysitenumber,
billtodefinitiveid,
enddefinitiveid,
shiptodefinitiveid,
soldtodefinitiveid,
billtoncesschid,
endncesschid,
shiptoncesschid,
soldtoncesschid,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
billtoaccounttype,
endaccounttype,
shiptoaccounttype,
soldtoaccounttype,
--so-661 new attributes addition ends
productcommissionclasscode,
billtoservicesmajoracc,  --so-665 new attributes addition starts
endservicesmajoracc,
shiptoservicesmajoracc,
soldtoservicesmajoracc,   --so-665 new attributes addition ends
billtocustomersubclass, --so-728 new attributes addition starts
endcustomersubclass,
shiptocustomersubclass,
soldtocustomersubclass,  --so-728 new attributes addition ends
serialnumber
)
/*Below query picks those records which corresponds to more than 1 office ids, and splits such records to have a row corresponding to 3rd office id*/
select
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
'0' as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
sp1.third_office_id as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
-- Case 
    -- when stg.sp1productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp1targetaccountflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,

cast(sp1.third_office_id_split_prct as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp1_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_commission_sp1_dop_claim sp1
on stg.SalesOfficeNumber = sp1.office_id 
  and (stg.invoicedate >= sp1.rollout_start_date and stg.invoicedate <= sp1.rollout_end_date)
  and stg.sp1productflag = 'TRUE'
  and sp1.asap_approval_outcome = 'Approve' 
  and stg.EndCustomerName = sp1.end_customer_name
  AND sp1.product_family like concat("%",stg.ProductFamily,"%")
  AND sp1.territory like concat("%",stg.salesofficeterritory,"%") 
where sp1.first_office_id_split_prct  < 1 AND sp1.second_office_id_split_prct > 0 AND sp1.third_office_id_split_prct > 0

union all

/*Below query picks those records which corresponds to more than 1 office ids, and splits such records to have a row corresponding to 2nd office id*/
select
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
'0' as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
sp1.second_office_id as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
-- Case 
    -- when stg.sp1productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp1targetaccountflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
cast(sp1.second_office_id_split_prct as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp1_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_commission_sp1_dop_claim sp1
on stg.SalesOfficeNumber=cast(sp1.office_id as string)
  and (stg.invoicedate >= sp1.rollout_start_date and stg.invoicedate <= sp1.rollout_end_date)
  and stg.sp1productflag = 'TRUE'
  and sp1.asap_approval_outcome = 'Approve' 
  and stg.EndCustomerName = sp1.end_customer_name
  AND sp1.product_family like concat("%",stg.ProductFamily,"%")
  AND sp1.territory like concat("%",stg.salesofficeterritory,"%") 
where sp1.first_office_id_split_prct  < 1 AND sp1.second_office_id_split_prct > 0 

union all

/*Below query picks those records which corresponds to more than 1 office id, and splits such records to have a row corresponding to 1st office id*/
select 
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
stg.originalsplitpercent as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
sp1.office_id as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
-- Case 
    -- when stg.sp1productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp1targetaccountflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
cast(sp1.first_office_id_split_prct as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp1_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_commission_sp1_dop_claim sp1
on stg.SalesOfficeNumber=cast(sp1.office_id as string)
  and (stg.invoicedate >= sp1.rollout_start_date and stg.invoicedate <= sp1.rollout_end_date)
  and stg.sp1productflag = 'TRUE'
  and sp1.asap_approval_outcome = 'Approve' 
  and stg.EndCustomerName = sp1.end_customer_name
  AND sp1.product_family like concat("%",stg.ProductFamily,"%")
  AND sp1.territory like concat("%",stg.salesofficeterritory,"%") 
	
where sp1.first_office_id_split_prct  < 1

union all

/*Below query picks those records which corresponds to exactly 1 office id, and keeps such records as it is.*/
select 
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
stg.originalsplitpercent as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
sp1.office_id as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
-- Case 
    -- when stg.sp1productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp1targetaccountflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
cast(sp1.first_office_id_split_prct as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp1_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office          
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_commission_sp1_dop_claim sp1
on stg.SalesOfficeNumber=cast(sp1.office_id as string)
     and (stg.invoicedate >= sp1.rollout_start_date and stg.invoicedate <= sp1.rollout_end_date)
     and stg.sp1productflag = 'TRUE'
	 and sp1.asap_approval_outcome = 'Approve' 
     and stg.EndCustomerName = sp1.end_customer_name
	 AND sp1.product_family like concat("%",stg.ProductFamily,"%")
     AND sp1.territory like concat("%",stg.salesofficeterritory,"%") 
where sp1.first_office_id_split_prct  = 1 or sp1.first_office_id_split_prct is null

union all

/*Below query picks those records which does not matches rule conditions, and keeps such records as it is.*/
select 
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
stg.originalsplitpercent as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
stg.salesofficenumber  as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
stg.splitpercent as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth ,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
left outer join @DB_LEVEL@_edm_other_src_silver.americas_channel_commission_sp1_dop_claim sp1_v
on stg.SalesOfficeNumber=cast(sp1_v.office_id as string)
    and (stg.invoicedate >= sp1_v.rollout_start_date and stg.invoicedate <= sp1_v.rollout_end_date)
    and stg.sp1productflag = 'TRUE'
	and sp1_v.asap_approval_outcome = 'Approve' 
    and stg.EndCustomerName = sp1_v.end_customer_name
    AND sp1_v.product_family like concat("%",stg.ProductFamily,"%")
    AND sp1_v.territory like concat("%",stg.salesofficeterritory,"%") 
where sp1_v.office_id is null 
;

8.Rule4_temp_to_stg

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_stg ;

insert into @DB_LEVEL@_edm_other_src_silver.pos_na_stg
select * from @DB_LEVEL@_edm_other_src_silver.pos_na_temp ;


9.Rule5_stg_to_temp

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_temp ;

INSERT INTO @DB_LEVEL@_edm_other_src_silver.pos_na_temp
(
accountservicesales,
accountsubtype,
accounttype,
activated,
activedate,
assignmentterritory,
billtocustomeraddress,
billtocustomercity,
billtocustomercountry,
billtocustomerenterpriseindustry,
billtocustomergicsinudstrygroupdescription,
billtocustomergicssectordescription,
billtocustomergsc,
billtocustomerid,
billtocustomerindustry,
billtocustomername,
billtocustomernumber,
billtocustomerparentaccount,
billtocustomerparentname,
billtocustomerpostalcode,
billtocustomerreportingname,
billtocustomerstandardizedname,
billtocustomerstate,
billtocustomersubvertical,
billtocustomertype,
billtocustomervertical,
billtoenterpriseindustry,
billtogsc_flag,
billtoindustry,
billtoindustrycode,
billtononrevenueflag,
billtoparentaccount,
billtostandardizedname,
cdwsalesarea,
cdwsalesregion,
cdwsalessegment,
cloudlistprice,
coe,
country,
crossrefwithlesnumber,
currency,
endcustomeraccountrole,
endcustomeraddress,
endcustomercity,
endcustomercountry,
endcustomercustomertype1,
endcustomerenterpriseindustry,
endcustomergscflag,
endcustomerid,
endcustomerindustry1,
endcustomerindustrycode1,
endcustomername,
endcustomerparentaccount,
endcustomerpostalcode,
endcustomerstandardizedname,
endcustomerstate,
endcustomersubvertical,
endcustomervertical,
extendedlistprice,
extendedstandardcost,
gbu,
hashedbilltocustomername,
hashedendcustomername,
hashedshiptocustomername,
hashedsoldtocustomername,
internalofficefamily,
internalofficename,
internalofficenumber,
internalofficeprincipalemail,
internalofficeprincipalname,
internalofficeregion,
internalofficesplit,
internalofficeterritory,
internalofficetype,
internalprincipalemail,
internalprincipalname,
invoicedate,
invoicelinenumber,
invoicenumber,
level6,
listprice,
lob,
multiplier,
namedaccountofficeassign,
namedaccountsplit,
netsalesrevenue,
newlescrossref2,
oemtag,
officelocation,
officetype,
originalsplitpercent,
posprojectregistrationnumber,
possku,
postalcodesofficeassign,
productcategory,
productfamily,
producthierarchylevel1description,
producthierarchylevel2description,
producthierarchylevel3description,
producthierarchylevel4code,
producthierarchylevel4description,
quantityshipped,
recordid,
recordsource,
region,
resellerbranchname,
resellerbranchnumber,
resellermajorcode,
resellerminorcode,
resellername,
resellernumber,
resellerpartnerlevel,
resellerpartnertype,
resellerregion,
resellersalesofficename,
resellersalesofficenumber,
responseid,
sales_area,
salesofficefamily,
salesofficename,
salesofficenumber,
salesofficenumber2,
salesofficeprincipalemail,
salesofficeprincipalname,
salesofficeregion,
salesofficeterritory,
salesordernumber,
salesoutprimarykey,
salesregion,
salesregion2,
salesrepemail,
salesrepid,
salesrepname,
segment,
shiptocustomeraddress,
shiptocustomercity,
shiptocustomercountry,
shiptocustomerenterpriseindustry,
shiptocustomergsc,
shiptocustomerid,
shiptocustomerindustry1,
shiptocustomername,
shiptocustomernumber,
shiptocustomerparentaccount,
shiptocustomerparentname,
shiptocustomerpostalcode,
shiptocustomerstandardizedname,
shiptocustomerstate,
shiptocustomersubvertical,
shiptocustomertype1,
shiptocustomertype1_2,
shiptocustomervertical,
shiptoenterpriseindustry,
shiptogsc_flag,
shiptoindustry1,
shiptoparentaccount,
shiptostandardizedname,
sizecategory,
sku,
skudescription,
soldtocustomeraddress,
soldtocustomercity,
soldtocustomercountry,
soldtocustomercustomergsc,
soldtocustomercustomertype1,
soldtocustomerindustry1,
soldtocustomername,
soldtocustomernumber,
soldtocustomerparentaccount,
soldtocustomerpostalcode,
soldtocustomerstate,
soldtocustomersubvertical,
soldtocustomervertical,
sp1productflag,
sp1targetaccountflag,
sp2productflag,
sp2targetaccountflag,
speed_dial,
splitpercent,
standard_products,
standardcost,
transactionamount,
transactiontype,
yearmonth,
intrachannelflag,
w_insert_dtm,
endcustomernumber,
--so-621 new attributes addition
billtocustomerclasscode,
endcustomerclasscode,
shiptocustomerclasscode,
soldtocustomerclasscode,
billtocustomerpartnerclasscode,
endcustomerpartnerclasscode,
shiptocustomerpartnerclasscode,
soldtocustomerpartnerclasscode,
billtooracleregistryid, 
endoracleregistryid,
shiptooracleregistryid,
soldtooracleregistryid,
billtocustomerindustry1,
billtocustomerindustry3,
endcustomerindustry3,
shiptocustomerindustry3,
soldtocustomerindustry3,
billtoreportingsubparent1,
endreportingsubparent1,
shiptoreportingsubparent1,
soldtoreportingsubparent1,
billtodefinitiveidnid,
enddefinitiveidnid,
shiptodefinitiveidnid,
soldtodefinitiveidnid,
billtodefinitiveidnidparentid,
enddefinitiveidnidparentid,
shiptodefinitiveidnidparentid,
soldtodefinitiveidnidparentid,
billtoncesleaid,
endncesleaid,
shiptoncesleaid,
soldtoncesleaid,
billtocustomerprovince,
endcustomerprovince,
shiptocustomerprovince,
soldtocustomerprovince,
billtooraclepartysitenumber,  
endoraclepartysitenumber,
shiptooraclepartysitenumber,
soldtooraclepartysitenumber,
billtodefinitiveid,
enddefinitiveid,
shiptodefinitiveid,
soldtodefinitiveid,
billtoncesschid,
endncesschid,
shiptoncesschid,
soldtoncesschid,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
billtoaccounttype,
endaccounttype,
shiptoaccounttype,
soldtoaccounttype,
--so-661 new attributes addition ends
productcommissionclasscode,
billtoservicesmajoracc,  --so-665 new attributes addition starts
endservicesmajoracc,
shiptoservicesmajoracc,
soldtoservicesmajoracc,   --so-665 new attributes addition ends
billtocustomersubclass, --so-728 new attributes addition starts
endcustomersubclass,
shiptocustomersubclass,
soldtocustomersubclass,  --so-728 new attributes addition ends
serialnumber

)
/*Below query picks those records which corresponds to more than 1 office ids, and splits such records to have a row corresponding to 3rd office id*/
select
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
'0' as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
cast(sp2.third_office_id as string) as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
-- Case 
    -- when stg.sp2productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp2targetaccountflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
cast(sp2.third_office_id_split_prcnt as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber


from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp2_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_comission_sp2_dop_claim sp2 
on stg.SalesOfficeNumber=cast(sp2.office_id as string)
    and (stg.invoicedate >= sp2.target_account_start_dt and stg.invoicedate <= sp2.target_account_end_dt)
	and stg.sp2productflag = 'TRUE'
	and sp2.asap_approval_outcome = 'Approve' 
	and stg.EndCustomerName = sp2.end_customer_name
where sp2.first_office_id_split_prcnt  < 1 AND sp2.second_office_id_split_prcnt > 0 AND sp2.third_office_id_split_prcnt > 0

union all

/*Below query picks those records which corresponds to more than 1 office ids, and splits such records to have a row corresponding to 2nd office id*/
select
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
'0' as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
cast(sp2.second_office_id as string) as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
-- Case 
    -- when stg.sp2productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp2targetaccountflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
cast(sp2.second_office_id_split_prcnt as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

 
from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp2_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_comission_sp2_dop_claim sp2 
on stg.SalesOfficeNumber=cast(sp2.office_id as string)
    and (stg.invoicedate >= sp2.target_account_start_dt and stg.invoicedate <= sp2.target_account_end_dt)
	and stg.sp2productflag = 'TRUE'
	and sp2.asap_approval_outcome = 'Approve' 
	and stg.EndCustomerName = sp2.end_customer_name
where sp2.first_office_id_split_prcnt  < 1 AND sp2.second_office_id_split_prcnt > 0 

union all

/*Below query picks those records which corresponds to more than 1 office id, and splits such records to have a row corresponding to 1st office id*/
select 
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
stg.originalsplitpercent as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
cast(sp2.office_id as string) as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
-- Case 
    -- when stg.sp2productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp2targetaccountflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
cast(sp2.first_office_id_split_prcnt as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag  as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber


from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg 
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp2_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_comission_sp2_dop_claim sp2 
on stg.SalesOfficeNumber=cast(sp2.office_id as string)
    and (stg.invoicedate >= sp2.target_account_start_dt and stg.invoicedate <= sp2.target_account_end_dt)
	and stg.sp2productflag = 'TRUE'
	and sp2.asap_approval_outcome = 'Approve' 
	and stg.EndCustomerName = sp2.end_customer_name
where sp2.first_office_id_split_prcnt  < 1

union all

/*Below query picks those records which corresponds to exactly 1 office id, and keeps such records as it is.*/
select 
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
stg.originalsplitpercent as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
cast(sp2.office_id as string) as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
-- Case 
    -- when stg.sp2productflag ='TRUE' AND stg.SalesOfficeNumber in ( name.office ) THEN 'TRUE'
	-- else'FALSE'
-- end as sp2targetaccountflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
cast(sp2.first_office_id_split_prcnt as string) as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg
-- left outer join 
     -- (select distinct cast(office as string) as office 
     -- from @DB_LEVEL@_edm_other_src_silver.sp2_named_accounts_to_office )name
-- on stg.SalesOfficeNumber = name.office
inner join @DB_LEVEL@_edm_other_src_silver.americas_channel_comission_sp2_dop_claim sp2 
on stg.SalesOfficeNumber=cast(sp2.office_id as string)
    and (stg.invoicedate >= sp2.target_account_start_dt and stg.invoicedate <= sp2.target_account_end_dt)
	and stg.sp2productflag = 'TRUE'
	and sp2.asap_approval_outcome = 'Approve' 
	and stg.EndCustomerName = sp2.end_customer_name
where sp2.first_office_id_split_prcnt  = 1 or sp2.first_office_id_split_prcnt  is null

union all

/*Below query picks those records which does not matches rule conditions, and keeps such records as it is.*/
select 
stg.accountservicesales as accountservicesales,
stg.accountsubtype as accountsubtype,
stg.accounttype as accounttype,
stg.activated as activated,
stg.activedate as activedate,
stg.assignmentterritory as assignmentterritory,
stg.billtocustomeraddress as billtocustomeraddress,
stg.billtocustomercity as billtocustomercity,
stg.billtocustomercountry as billtocustomercountry,
stg.billtocustomerenterpriseindustry as billtocustomerenterpriseindustry,
stg.billtocustomergicsinudstrygroupdescription as billtocustomergicsinudstrygroupdescription,
stg.billtocustomergicssectordescription as billtocustomergicssectordescription,
stg.billtocustomergsc as billtocustomergsc,
stg.billtocustomerid as billtocustomerid,
stg.billtocustomerindustry as billtocustomerindustry,
stg.billtocustomername as billtocustomername,
stg.billtocustomernumber as billtocustomernumber,
stg.billtocustomerparentaccount as billtocustomerparentaccount,
stg.billtocustomerparentname as billtocustomerparentname,
stg.billtocustomerpostalcode as billtocustomerpostalcode,
stg.billtocustomerreportingname as billtocustomerreportingname,
stg.billtocustomerstandardizedname as billtocustomerstandardizedname,
stg.billtocustomerstate as billtocustomerstate,
stg.billtocustomersubvertical as billtocustomersubvertical,
stg.billtocustomertype as billtocustomertype,
stg.billtocustomervertical as billtocustomervertical,
stg.billtoenterpriseindustry as billtoenterpriseindustry,
stg.billtogsc_flag as billtogsc_flag,
stg.billtoindustry as billtoindustry,
stg.billtoindustrycode as billtoindustrycode,
stg.billtononrevenueflag as billtononrevenueflag,
stg.billtoparentaccount as billtoparentaccount,
stg.billtostandardizedname as billtostandardizedname,
stg.cdwsalesarea as cdwsalesarea,
stg.cdwsalesregion as cdwsalesregion,
stg.cdwsalessegment as cdwsalessegment,
stg.cloudlistprice as cloudlistprice,
stg.coe as coe,
stg.country as country,
stg.crossrefwithlesnumber as crossrefwithlesnumber,
stg.currency as currency,
stg.endcustomeraccountrole as endcustomeraccountrole,
stg.endcustomeraddress as endcustomeraddress,
stg.endcustomercity as endcustomercity,
stg.endcustomercountry as endcustomercountry,
stg.endcustomercustomertype1 as endcustomercustomertype1,
stg.endcustomerenterpriseindustry as endcustomerenterpriseindustry,
stg.endcustomergscflag as endcustomergscflag,
stg.endcustomerid as endcustomerid,
stg.endcustomerindustry1 as endcustomerindustry1,
stg.endcustomerindustrycode1 as endcustomerindustrycode1,
stg.endcustomername as endcustomername,
stg.endcustomerparentaccount as endcustomerparentaccount,
stg.endcustomerpostalcode as endcustomerpostalcode,
stg.endcustomerstandardizedname as endcustomerstandardizedname,
stg.endcustomerstate as endcustomerstate,
stg.endcustomersubvertical as endcustomersubvertical,
stg.endcustomervertical as endcustomervertical,
stg.extendedlistprice as extendedlistprice,
stg.extendedstandardcost as extendedstandardcost,
stg.gbu as gbu,
stg.hashedbilltocustomername as hashedbilltocustomername,
stg.hashedendcustomername as hashedendcustomername,
stg.hashedshiptocustomername as hashedshiptocustomername,
stg.hashedsoldtocustomername as hashedsoldtocustomername,
stg.internalofficefamily as internalofficefamily,
stg.internalofficename as internalofficename,
stg.internalofficenumber as internalofficenumber,
stg.internalofficeprincipalemail as internalofficeprincipalemail,
stg.internalofficeprincipalname as internalofficeprincipalname,
stg.internalofficeregion as internalofficeregion,
stg.internalofficesplit as internalofficesplit,
stg.internalofficeterritory as internalofficeterritory,
stg.internalofficetype as internalofficetype,
stg.internalprincipalemail as internalprincipalemail,
stg.internalprincipalname as internalprincipalname,
stg.invoicedate as invoicedate,
stg.invoicelinenumber as invoicelinenumber,
stg.invoicenumber as invoicenumber,
stg.level6 as level6,
stg.listprice as listprice,
stg.lob as lob,
stg.multiplier as multiplier,
stg.namedaccountofficeassign as namedaccountofficeassign,
stg.namedaccountsplit as namedaccountsplit,
stg.netsalesrevenue as netsalesrevenue,
stg.newlescrossref2 as newlescrossref2,
stg.oemtag as oemtag,
stg.officelocation as officelocation,
stg.officetype as officetype,
stg.originalsplitpercent as originalsplitpercent,
stg.posprojectregistrationnumber as posprojectregistrationnumber,
stg.possku as possku,
stg.postalcodesofficeassign as postalcodesofficeassign,
stg.productcategory as productcategory,
stg.productfamily as productfamily,
stg.producthierarchylevel1description as producthierarchylevel1description,
stg.producthierarchylevel2description as producthierarchylevel2description,
stg.producthierarchylevel3description as producthierarchylevel3description,
stg.producthierarchylevel4code as producthierarchylevel4code,
stg.producthierarchylevel4description as producthierarchylevel4description,
stg.quantityshipped as quantityshipped,
stg.recordid as recordid,
stg.recordsource as recordsource,
stg.region as region,
stg.resellerbranchname as resellerbranchname,
stg.resellerbranchnumber as resellerbranchnumber,
stg.resellermajorcode as resellermajorcode,
stg.resellerminorcode as resellerminorcode,
stg.resellername as resellername,
stg.resellernumber as resellernumber,
stg.resellerpartnerlevel as resellerpartnerlevel,
stg.resellerpartnertype as resellerpartnertype,
stg.resellerregion as resellerregion,
stg.resellersalesofficename as resellersalesofficename,
stg.resellersalesofficenumber as resellersalesofficenumber,
stg.responseid as responseid,
stg.sales_area as sales_area,
stg.salesofficefamily as salesofficefamily,
stg.salesofficename as salesofficename,
stg.salesofficenumber as salesofficenumber,
stg.salesofficenumber2 as salesofficenumber2,
stg.salesofficeprincipalemail as salesofficeprincipalemail,
stg.salesofficeprincipalname as salesofficeprincipalname,
stg.salesofficeregion as salesofficeregion,
stg.salesofficeterritory as salesofficeterritory,
stg.salesordernumber as salesordernumber,
stg.salesoutprimarykey as salesoutprimarykey,
stg.salesregion as salesregion,
stg.salesregion2 as salesregion2,
stg.salesrepemail as salesrepemail,
stg.salesrepid as salesrepid,
stg.salesrepname as salesrepname,
stg.segment as segment,
stg.shiptocustomeraddress as shiptocustomeraddress,
stg.shiptocustomercity as shiptocustomercity,
stg.shiptocustomercountry as shiptocustomercountry,
stg.shiptocustomerenterpriseindustry as shiptocustomerenterpriseindustry,
stg.shiptocustomergsc as shiptocustomergsc,
stg.shiptocustomerid as shiptocustomerid,
stg.shiptocustomerindustry1 as shiptocustomerindustry1,
stg.shiptocustomername as shiptocustomername,
stg.shiptocustomernumber as shiptocustomernumber,
stg.shiptocustomerparentaccount as shiptocustomerparentaccount,
stg.shiptocustomerparentname as shiptocustomerparentname,
stg.shiptocustomerpostalcode as shiptocustomerpostalcode,
stg.shiptocustomerstandardizedname as shiptocustomerstandardizedname,
stg.shiptocustomerstate as shiptocustomerstate,
stg.shiptocustomersubvertical as shiptocustomersubvertical,
stg.shiptocustomertype1 as shiptocustomertype1,
stg.shiptocustomertype1_2 as shiptocustomertype1_2,
stg.shiptocustomervertical as shiptocustomervertical,
stg.shiptoenterpriseindustry as shiptoenterpriseindustry,
stg.shiptogsc_flag as shiptogsc_flag,
stg.shiptoindustry1 as shiptoindustry1,
stg.shiptoparentaccount as shiptoparentaccount,
stg.shiptostandardizedname as shiptostandardizedname,
stg.sizecategory as sizecategory,
stg.sku as sku,
stg.skudescription as skudescription,
stg.soldtocustomeraddress as soldtocustomeraddress,
stg.soldtocustomercity as soldtocustomercity,
stg.soldtocustomercountry as soldtocustomercountry,
stg.soldtocustomercustomergsc as soldtocustomercustomergsc,
stg.soldtocustomercustomertype1 as soldtocustomercustomertype1,
stg.soldtocustomerindustry1 as soldtocustomerindustry1,
stg.soldtocustomername as soldtocustomername,
stg.soldtocustomernumber as soldtocustomernumber,
stg.soldtocustomerparentaccount as soldtocustomerparentaccount,
stg.soldtocustomerpostalcode as soldtocustomerpostalcode,
stg.soldtocustomerstate as soldtocustomerstate,
stg.soldtocustomersubvertical as soldtocustomersubvertical,
stg.soldtocustomervertical as soldtocustomervertical,
stg.sp1productflag as sp1productflag,
stg.sp1targetaccountflag as sp1targetaccountflag,
stg.sp2productflag as sp2productflag,
stg.sp2targetaccountflag as sp2targetaccountflag,
stg.speed_dial as speed_dial,
stg.splitpercent as splitpercent,
stg.standard_products as standard_products,
stg.standardcost as standardcost,
stg.transactionamount as transactionamount,
stg.transactiontype as transactiontype,
stg.yearmonth as yearmonth,
stg.intrachannelflag as intrachannelflag,
stg.w_insert_dtm as w_insert_dtm,
stg.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
stg.billtocustomerclasscode as billtocustomerclasscode ,
stg.endcustomerclasscode as endcustomerclasscode ,
stg.shiptocustomerclasscode as shiptocustomerclasscode ,
stg.soldtocustomerclasscode as soldtocustomerclasscode ,
stg.billtocustomerpartnerclasscode as billtocustomerpartnerclasscode ,
stg.endcustomerpartnerclasscode as endcustomerpartnerclasscode ,
stg.shiptocustomerpartnerclasscode as shiptocustomerpartnerclasscode ,
stg.soldtocustomerpartnerclasscode as soldtocustomerpartnerclasscode ,
stg.billtooracleregistryid as billtooracleregistryid , 
stg.endoracleregistryid as endoracleregistryid ,
stg.shiptooracleregistryid as shiptooracleregistryid ,
stg.soldtooracleregistryid as soldtooracleregistryid ,
stg.billtocustomerindustry1 as billtocustomerindustry1 ,
stg.billtocustomerindustry3 as billtocustomerindustry3 ,
stg.endcustomerindustry3 as endcustomerindustry3 ,
stg.shiptocustomerindustry3 as shiptocustomerindustry3 ,
stg.soldtocustomerindustry3 as soldtocustomerindustry3 ,
stg.billtoreportingsubparent1 as billtoreportingsubparent1 ,
stg.endreportingsubparent1 as endreportingsubparent1 ,
stg.shiptoreportingsubparent1 as shiptoreportingsubparent1 ,
stg.soldtoreportingsubparent1 as soldtoreportingsubparent1 ,
stg.billtodefinitiveidnid as billtodefinitiveidnid ,
stg.enddefinitiveidnid as enddefinitiveidnid ,
stg.shiptodefinitiveidnid as shiptodefinitiveidnid ,
stg.soldtodefinitiveidnid as soldtodefinitiveidnid ,
stg.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid ,
stg.enddefinitiveidnidparentid as enddefinitiveidnidparentid ,
stg.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid ,
stg.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid ,
stg.billtoncesleaid as billtoncesleaid ,
stg.endncesleaid as endncesleaid ,
stg.shiptoncesleaid as shiptoncesleaid ,
stg.soldtoncesleaid as soldtoncesleaid ,
stg.billtocustomerprovince as billtocustomerprovince ,
stg.endcustomerprovince as endcustomerprovince ,
stg.shiptocustomerprovince as shiptocustomerprovince ,
stg.soldtocustomerprovince as soldtocustomerprovince ,
stg.billtooraclepartysitenumber as billtooraclepartysitenumber ,  
stg.endoraclepartysitenumber as endoraclepartysitenumber ,
stg.shiptooraclepartysitenumber as shiptooraclepartysitenumber ,
stg.soldtooraclepartysitenumber as soldtooraclepartysitenumber ,
stg.billtodefinitiveid as billtodefinitiveid ,
stg.enddefinitiveid as enddefinitiveid ,
stg.shiptodefinitiveid as shiptodefinitiveid ,
stg.soldtodefinitiveid as soldtodefinitiveid ,
stg.billtoncesschid as billtoncesschid ,
stg.endncesschid as endncesschid ,
stg.shiptoncesschid as shiptoncesschid ,
stg.soldtoncesschid as soldtoncesschid ,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
stg.billtoaccounttype as billtoaccounttype ,
stg.endaccounttype as endaccounttype ,
stg.shiptoaccounttype as shiptoaccounttype ,
stg.soldtoaccounttype as soldtoaccounttype,
--so-661 new attributes addition ends
stg.productcommissionclasscode as productcommissionclasscode,
stg.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
stg.endservicesmajoracc as endservicesmajoracc,
stg.shiptoservicesmajoracc as shiptoservicesmajoracc,
stg.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
stg.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
stg.endcustomersubclass as endcustomersubclass,
stg.shiptocustomersubclass as shiptocustomersubclass,
stg.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
stg.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg stg

left outer join @DB_LEVEL@_edm_other_src_silver.americas_channel_comission_sp2_dop_claim sp2_v 
on stg.SalesOfficeNumber=cast(sp2_v.office_id as string)
    and (stg.invoicedate >= sp2_v.target_account_start_dt and stg.invoicedate <= sp2_v.target_account_end_dt)
	and stg.sp2productflag = 'TRUE'
	and sp2_v.asap_approval_outcome = 'Approve' 
	and stg.EndCustomerName = sp2_v.end_customer_name
where sp2_v.office_id is null
;

10.Rule5a_temp_to_stg

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_stg ;

INSERT INTO @DB_LEVEL@_edm_other_src_silver.pos_na_stg
(
accountservicesales,
accountsubtype,
accounttype,
activated,
activedate,
assignmentterritory,
billtocustomeraddress,
billtocustomercity,
billtocustomercountry,
billtocustomerenterpriseindustry,
billtocustomergicsinudstrygroupdescription,
billtocustomergicssectordescription,
billtocustomergsc,
billtocustomerid,
billtocustomerindustry,
billtocustomername,
billtocustomernumber,
billtocustomerparentaccount,
billtocustomerparentname,
billtocustomerpostalcode,
billtocustomerreportingname,
billtocustomerstandardizedname,
billtocustomerstate,
billtocustomersubvertical,
billtocustomertype,
billtocustomervertical,
billtoenterpriseindustry,
billtogsc_flag,
billtoindustry,
billtoindustrycode,
billtononrevenueflag,
billtoparentaccount,
billtostandardizedname,
cdwsalesarea,
cdwsalesregion,
cdwsalessegment,
cloudlistprice,
coe,
country,
crossrefwithlesnumber,
currency,
endcustomeraccountrole,
endcustomeraddress,
endcustomercity,
endcustomercountry,
endcustomercustomertype1,
endcustomerenterpriseindustry,
endcustomergscflag,
endcustomerid,
endcustomerindustry1,
endcustomerindustrycode1,
endcustomername,
endcustomerparentaccount,
endcustomerpostalcode,
endcustomerstandardizedname,
endcustomerstate,
endcustomersubvertical,
endcustomervertical,
extendedlistprice,
extendedstandardcost,
gbu,
hashedbilltocustomername,
hashedendcustomername,
hashedshiptocustomername,
hashedsoldtocustomername,
internalofficefamily,
internalofficename,
internalofficenumber,
internalofficeprincipalemail,
internalofficeprincipalname,
internalofficeregion,
internalofficesplit,
internalofficeterritory,
internalofficetype,
internalprincipalemail,
internalprincipalname,
invoicedate,
invoicelinenumber,
invoicenumber,
level6,
listprice,
lob,
multiplier,
namedaccountofficeassign,
namedaccountsplit,
netsalesrevenue,
newlescrossref2,
oemtag,
officelocation,
officetype,
originalsplitpercent,
posprojectregistrationnumber,
possku,
postalcodesofficeassign,
productcategory,
productfamily,
producthierarchylevel1description,
producthierarchylevel2description,
producthierarchylevel3description,
producthierarchylevel4code,
producthierarchylevel4description,
quantityshipped,
recordid,
recordsource,
region,
resellerbranchname,
resellerbranchnumber,
resellermajorcode,
resellerminorcode,
resellername,
resellernumber,
resellerpartnerlevel,
resellerpartnertype,
resellerregion,
resellersalesofficename,
resellersalesofficenumber,
responseid,
sales_area,
salesofficefamily,
salesofficename,
salesofficenumber,
salesofficenumber2,
salesofficeprincipalemail,
salesofficeprincipalname,
salesofficeregion,
salesofficeterritory,
salesordernumber,
salesoutprimarykey,
salesregion,
salesregion2,
salesrepemail,
salesrepid,
salesrepname,
segment,
shiptocustomeraddress,
shiptocustomercity,
shiptocustomercountry,
shiptocustomerenterpriseindustry,
shiptocustomergsc,
shiptocustomerid,
shiptocustomerindustry1,
shiptocustomername,
shiptocustomernumber,
shiptocustomerparentaccount,
shiptocustomerparentname,
shiptocustomerpostalcode,
shiptocustomerstandardizedname,
shiptocustomerstate,
shiptocustomersubvertical,
shiptocustomertype1,
shiptocustomertype1_2,
shiptocustomervertical,
shiptoenterpriseindustry,
shiptogsc_flag,
shiptoindustry1,
shiptoparentaccount,
shiptostandardizedname,
sizecategory,
sku,
skudescription,
soldtocustomeraddress,
soldtocustomercity,
soldtocustomercountry,
soldtocustomercustomergsc,
soldtocustomercustomertype1,
soldtocustomerindustry1,
soldtocustomername,
soldtocustomernumber,
soldtocustomerparentaccount,
soldtocustomerpostalcode,
soldtocustomerstate,
soldtocustomersubvertical,
soldtocustomervertical,
sp1productflag,
sp1targetaccountflag,
sp2productflag,
sp2targetaccountflag,
speed_dial,
splitpercent,
standard_products,
standardcost,
transactionamount,
transactiontype,
yearmonth,
intrachannelflag,
w_insert_dtm,
endcustomernumber,
--so-621 new attributes addition
billtocustomerclasscode,
endcustomerclasscode,
shiptocustomerclasscode,
soldtocustomerclasscode,
billtocustomerpartnerclasscode,
endcustomerpartnerclasscode,
shiptocustomerpartnerclasscode,
soldtocustomerpartnerclasscode,
billtooracleregistryid, 
endoracleregistryid,
shiptooracleregistryid,
soldtooracleregistryid,
billtocustomerindustry1,
billtocustomerindustry3,
endcustomerindustry3,
shiptocustomerindustry3,
soldtocustomerindustry3,
billtoreportingsubparent1,
endreportingsubparent1,
shiptoreportingsubparent1,
soldtoreportingsubparent1,
billtodefinitiveidnid,
enddefinitiveidnid,
shiptodefinitiveidnid,
soldtodefinitiveidnid,
billtodefinitiveidnidparentid,
enddefinitiveidnidparentid,
shiptodefinitiveidnidparentid,
soldtodefinitiveidnidparentid,
billtoncesleaid,
endncesleaid,
shiptoncesleaid,
soldtoncesleaid,
billtocustomerprovince,
endcustomerprovince,
shiptocustomerprovince,
soldtocustomerprovince,
billtooraclepartysitenumber,  
endoraclepartysitenumber,
shiptooraclepartysitenumber,
soldtooraclepartysitenumber,
billtodefinitiveid,
enddefinitiveid,
shiptodefinitiveid,
soldtodefinitiveid,
billtoncesschid,
endncesschid,
shiptoncesschid,
soldtoncesschid,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
billtoaccounttype,
endaccounttype,
shiptoaccounttype,
soldtoaccounttype,
--so-661 new attributes addition ends
productcommissionclasscode,
billtoservicesmajoracc,  --so-665 new attributes addition starts
endservicesmajoracc,
shiptoservicesmajoracc,
soldtoservicesmajoracc,   --so-665 new attributes addition ends
billtocustomersubclass, --so-728 new attributes addition starts
endcustomersubclass,
shiptocustomersubclass,
soldtocustomersubclass,  --so-728 new attributes addition ends
serialnumber
)

select
temp.accountservicesales as accountservicesales,
temp.accountsubtype as accountsubtype,
temp.accounttype as accounttype,
temp.activated as activated,
temp.activedate as activedate,
temp.assignmentterritory as assignmentterritory,
upper(temp.billtocustomeraddress) as billtocustomeraddress,
upper(temp.billtocustomercity) as billtocustomercity,
upper(temp.billtocustomercountry) as billtocustomercountry,
upper(temp.billtocustomerenterpriseindustry) as billtocustomerenterpriseindustry,
upper(temp.billtocustomergicsinudstrygroupdescription) as billtocustomergicsinudstrygroupdescription,
upper(temp.billtocustomergicssectordescription) as billtocustomergicssectordescription,
upper(temp.billtocustomergsc) as billtocustomergsc,
temp.billtocustomerid as billtocustomerid,
upper(temp.billtocustomerindustry) as billtocustomerindustry,
upper(temp.billtocustomername) as billtocustomername,
temp.billtocustomernumber as billtocustomernumber,
upper(temp.billtocustomerparentaccount) as billtocustomerparentaccount,
upper(temp.billtocustomerparentname) as billtocustomerparentname,
temp.billtocustomerpostalcode as billtocustomerpostalcode,
upper(temp.billtocustomerreportingname) as billtocustomerreportingname,
upper(temp.billtocustomerstandardizedname) as billtocustomerstandardizedname,
upper(temp.billtocustomerstate) as billtocustomerstate,
upper(temp.billtocustomersubvertical) as billtocustomersubvertical,
upper(temp.billtocustomertype) as billtocustomertype,
upper(temp.billtocustomervertical) as billtocustomervertical,
temp.billtoenterpriseindustry as billtoenterpriseindustry,
temp.billtogsc_flag as billtogsc_flag,
temp.billtoindustry as billtoindustry,
temp.billtoindustrycode as billtoindustrycode,
temp.billtononrevenueflag as billtononrevenueflag,
temp.billtoparentaccount as billtoparentaccount,
temp.billtostandardizedname as billtostandardizedname,
temp.cdwsalesarea as cdwsalesarea,
temp.cdwsalesregion as cdwsalesregion,
temp.cdwsalessegment as cdwsalessegment,
temp.cloudlistprice as cloudlistprice,
upper(temp.coe) as coe,
temp.country as country,
temp.crossrefwithlesnumber as crossrefwithlesnumber,
temp.currency as currency,
upper(temp.endcustomeraccountrole) as endcustomeraccountrole,
upper(temp.endcustomeraddress) as endcustomeraddress,
upper(temp.endcustomercity) as endcustomercity,
upper(temp.endcustomercountry) as endcustomercountry,
temp.endcustomercustomertype1 as endcustomercustomertype1,
upper(temp.endcustomerenterpriseindustry) as endcustomerenterpriseindustry,
upper(temp.endcustomergscflag) as endcustomergscflag,
temp.endcustomerid as endcustomerid,
upper(temp.endcustomerindustry1) as endcustomerindustry1,
upper(temp.endcustomerindustrycode1) as endcustomerindustrycode1,
upper(temp.endcustomername) as endcustomername,
upper(temp.endcustomerparentaccount) as endcustomerparentaccount,
temp.endcustomerpostalcode as endcustomerpostalcode,
upper(temp.endcustomerstandardizedname) as endcustomerstandardizedname,
upper(temp.endcustomerstate) as endcustomerstate,
upper(temp.endcustomersubvertical) as endcustomersubvertical,
upper(temp.endcustomervertical) as endcustomervertical,
temp.extendedlistprice as extendedlistprice,
temp.extendedstandardcost as extendedstandardcost,
upper(temp.gbu) as gbu,
upper(temp.hashedbilltocustomername) as hashedbilltocustomername,
upper(temp.hashedendcustomername) as hashedendcustomername,
upper(temp.hashedshiptocustomername) as hashedshiptocustomername,
upper(temp.hashedsoldtocustomername) as hashedsoldtocustomername,
temp.internalofficefamily as internalofficefamily,
temp.internalofficename as internalofficename,
temp.internalofficenumber as internalofficenumber,
temp.internalofficeprincipalemail as internalofficeprincipalemail,
temp.internalofficeprincipalname as internalofficeprincipalname,
temp.internalofficeregion as internalofficeregion,
temp.internalofficesplit as internalofficesplit,
temp.internalofficeterritory as internalofficeterritory,
temp.internalofficetype as internalofficetype,
temp.internalprincipalemail as internalprincipalemail,
temp.internalprincipalname as internalprincipalname,
temp.invoicedate as invoicedate,
temp.invoicelinenumber as invoicelinenumber,
temp.invoicenumber as invoicenumber,
upper(temp.level6) as level6,
temp.listprice as listprice,
upper(temp.lob) as lob,
temp.multiplier as multiplier,
temp.namedaccountofficeassign as namedaccountofficeassign,
temp.namedaccountsplit as namedaccountsplit,
temp.netsalesrevenue as netsalesrevenue,
temp.newlescrossref2 as newlescrossref2,
temp.oemtag as oemtag,
temp.officelocation as officelocation,
temp.officetype as officetype,
temp.originalsplitpercent as originalsplitpercent,
temp.posprojectregistrationnumber as posprojectregistrationnumber,
temp.possku as possku,
temp.postalcodesofficeassign as postalcodesofficeassign,
upper(temp.productcategory) as productcategory,
upper(temp.productfamily) as productfamily,
temp.producthierarchylevel1description as producthierarchylevel1description,
temp.producthierarchylevel2description as producthierarchylevel2description,
temp.producthierarchylevel3description as producthierarchylevel3description,
temp.producthierarchylevel4code as producthierarchylevel4code,
temp.producthierarchylevel4description as producthierarchylevel4description,
temp.quantityshipped as quantityshipped,
temp.recordid as recordid,
temp.recordsource as recordsource,
temp.region as region,
temp.resellerbranchname as resellerbranchname,
temp.resellerbranchnumber as resellerbranchnumber,
temp.resellermajorcode as resellermajorcode,
temp.resellerminorcode as resellerminorcode,
temp.resellername as resellername,
temp.resellernumber as resellernumber,
temp.resellerpartnerlevel as resellerpartnerlevel,
temp.resellerpartnertype as resellerpartnertype,
temp.resellerregion as resellerregion,
temp.resellersalesofficename as resellersalesofficename,
temp.resellersalesofficenumber as resellersalesofficenumber,
temp.responseid as responseid,
temp.sales_area as sales_area,
IFNULL(roi.office_family,temp.salesofficefamily) as salesofficefamily,
IFNULL(roi.office_name,temp.salesofficename) as salesofficename,
temp.salesofficenumber as salesofficenumber,
temp.salesofficenumber2 as salesofficenumber2,
IFNULL(roi.principal_email,temp.salesofficeprincipalemail) as salesofficeprincipalemail,
IFNULL(roi.principal,temp.salesofficeprincipalname) as salesofficeprincipalname,
IFNULL((decode(roi.country,'USA',replace(roi.sales_region,'Midwest','US - Midwest'),roi.sales_region )),temp.salesofficeregion) as salesofficeregion,  
IFNULL((decode(roi.country,'USA',replace(roi.sales_region,'Midwest','US - Midwest'),roi.sales_region )),temp.salesofficeterritory) as salesofficeterritory, 
temp.salesordernumber as salesordernumber,
temp.salesoutprimarykey as salesoutprimarykey,
temp.salesregion as salesregion,
temp.salesregion2 as salesregion2,
temp.salesrepemail as salesrepemail,
temp.salesrepid as salesrepid,
temp.salesrepname as salesrepname,
temp.segment as segment,
upper(temp.shiptocustomeraddress) as shiptocustomeraddress,
upper(temp.shiptocustomercity) as shiptocustomercity,
upper(temp.shiptocustomercountry) as shiptocustomercountry,
upper(temp.shiptocustomerenterpriseindustry) as shiptocustomerenterpriseindustry,
upper(temp.shiptocustomergsc) as shiptocustomergsc,
temp.shiptocustomerid as shiptocustomerid,
upper(temp.shiptocustomerindustry1) as shiptocustomerindustry1,
upper(temp.shiptocustomername) as shiptocustomername,
temp.shiptocustomernumber as shiptocustomernumber,
upper(temp.shiptocustomerparentaccount) as shiptocustomerparentaccount,
upper(temp.shiptocustomerparentname) as shiptocustomerparentname,
temp.shiptocustomerpostalcode as shiptocustomerpostalcode,
upper(temp.shiptocustomerstandardizedname) as shiptocustomerstandardizedname,
upper(temp.shiptocustomerstate) as shiptocustomerstate,
upper(temp.shiptocustomersubvertical) as shiptocustomersubvertical,
upper(temp.shiptocustomertype1) as shiptocustomertype1,
upper(temp.shiptocustomertype1_2) as shiptocustomertype1_2,
upper(temp.shiptocustomervertical) as shiptocustomervertical,
temp.shiptoenterpriseindustry as shiptoenterpriseindustry,
temp.shiptogsc_flag as shiptogsc_flag,
temp.shiptoindustry1 as shiptoindustry1,
temp.shiptoparentaccount as shiptoparentaccount,
temp.shiptostandardizedname as shiptostandardizedname,
temp.sizecategory as sizecategory,
upper(temp.sku) as sku,
upper(temp.skudescription) as skudescription,
upper(temp.soldtocustomeraddress) as soldtocustomeraddress,
upper(temp.soldtocustomercity) as soldtocustomercity,
upper(temp.soldtocustomercountry) as soldtocustomercountry,
upper(temp.soldtocustomercustomergsc) as soldtocustomercustomergsc,
upper(temp.soldtocustomercustomertype1) as soldtocustomercustomertype1,
upper(temp.soldtocustomerindustry1) as soldtocustomerindustry1,
upper(temp.soldtocustomername) as soldtocustomername,
temp.soldtocustomernumber as soldtocustomernumber,
upper(temp.soldtocustomerparentaccount) as soldtocustomerparentaccount,
temp.soldtocustomerpostalcode as soldtocustomerpostalcode,
upper(temp.soldtocustomerstate) as soldtocustomerstate,
upper(temp.soldtocustomersubvertical) as soldtocustomersubvertical,
upper(temp.soldtocustomervertical) as soldtocustomervertical,
temp.sp1productflag as sp1productflag,
temp.sp1targetaccountflag as sp1targetaccountflag,
temp.sp2productflag as sp2productflag,
temp.sp2targetaccountflag as sp2targetaccountflag,
temp.speed_dial as speed_dial,
temp.splitpercent as splitpercent,
temp.standard_products as standard_products,
temp.standardcost as standardcost,
temp.transactionamount as transactionamount,
temp.transactiontype as transactiontype,
temp.yearmonth as yearmonth,
temp.intrachannelflag as intrachannelflag,
temp.w_insert_dtm as w_insert_dtm,
temp.endcustomernumber as endcustomernumber,
--so-621 new attributes addition
upper(temp.billtocustomerclasscode) as billtocustomerclasscode,
upper(temp.endcustomerclasscode) as endcustomerclasscode,
upper(temp.shiptocustomerclasscode) as shiptocustomerclasscode,
upper(temp.soldtocustomerclasscode) as soldtocustomerclasscode,
upper(temp.billtocustomerpartnerclasscode) as billtocustomerpartnerclasscode,
upper(temp.endcustomerpartnerclasscode) as endcustomerpartnerclasscode,
upper(temp.shiptocustomerpartnerclasscode) as shiptocustomerpartnerclasscode,
upper(temp.soldtocustomerpartnerclasscode) as soldtocustomerpartnerclasscode,
temp.billtooracleregistryid as billtooracleregistryid,
temp.endoracleregistryid as endoracleregistryid,
temp.shiptooracleregistryid as shiptooracleregistryid,
temp.soldtooracleregistryid as soldtooracleregistryid,
upper(temp.billtocustomerindustry1) as billtocustomerindustry1,
upper(temp.billtocustomerindustry3) as billtocustomerindustry3,
upper(temp.endcustomerindustry3) as endcustomerindustry3,
upper(temp.shiptocustomerindustry3) as shiptocustomerindustry3,
upper(temp.soldtocustomerindustry3) as soldtocustomerindustry3,
upper(temp.billtoreportingsubparent1) as billtoreportingsubparent1,
upper(temp.endreportingsubparent1) as endreportingsubparent1,
upper(temp.shiptoreportingsubparent1) as shiptoreportingsubparent1,
upper(temp.soldtoreportingsubparent1) as soldtoreportingsubparent1,
temp.billtodefinitiveidnid as billtodefinitiveidnid,
temp.enddefinitiveidnid as enddefinitiveidnid,
temp.shiptodefinitiveidnid as shiptodefinitiveidnid,
temp.soldtodefinitiveidnid as soldtodefinitiveidnid,
temp.billtodefinitiveidnidparentid as billtodefinitiveidnidparentid,
temp.enddefinitiveidnidparentid as enddefinitiveidnidparentid,
temp.shiptodefinitiveidnidparentid as shiptodefinitiveidnidparentid,
temp.soldtodefinitiveidnidparentid as soldtodefinitiveidnidparentid,
temp.billtoncesleaid as billtoncesleaid,
temp.endncesleaid as endncesleaid,
temp.shiptoncesleaid as shiptoncesleaid,
temp.soldtoncesleaid as soldtoncesleaid,
upper(temp.billtocustomerprovince) as billtocustomerprovince,
upper(temp.endcustomerprovince) as endcustomerprovince,
upper(temp.shiptocustomerprovince) as shiptocustomerprovince,
upper(temp.soldtocustomerprovince) as soldtocustomerprovince,
temp.billtooraclepartysitenumber as billtooraclepartysitenumber,
temp.endoraclepartysitenumber as endoraclepartysitenumber,
temp.shiptooraclepartysitenumber as shiptooraclepartysitenumber,
temp.soldtooraclepartysitenumber as soldtooraclepartysitenumber,
temp.billtodefinitiveid as billtodefinitiveid,
temp.enddefinitiveid as enddefinitiveid,
temp.shiptodefinitiveid as shiptodefinitiveid,
temp.soldtodefinitiveid as soldtodefinitiveid,
temp.billtoncesschid as billtoncesschid,
temp.endncesschid as endncesschid,
temp.shiptoncesschid as shiptoncesschid,
temp.soldtoncesschid as soldtoncesschid,
--so-621 new attributes addition ends
--so-661 new attributes addition starts
upper(temp.billtoaccounttype) as billtoaccounttype,
upper(temp.endaccounttype) as endaccounttype,
upper(temp.shiptoaccounttype) as shiptoaccounttype,
upper(temp.soldtoaccounttype) as soldtoaccounttype,
--so-661 new attributes addition ends
temp.productcommissionclasscode as productcommissionclasscode,
temp.billtoservicesmajoracc as billtoservicesmajoracc,  --so-665 new attributes addition starts
temp.endservicesmajoracc as endservicesmajoracc,
temp.shiptoservicesmajoracc as shiptoservicesmajoracc,
temp.soldtoservicesmajoracc as soldtoservicesmajoracc,   --so-665 new attributes addition ends
temp.billtocustomersubclass as billtocustomersubclass, --so-728 new attributes addition starts
temp.endcustomersubclass as endcustomersubclass,
temp.shiptocustomersubclass as shiptocustomersubclass,
temp.soldtocustomersubclass as soldtocustomersubclass,  --so-728 new attributes addition ends
temp.serialnumber as serialnumber

from @DB_LEVEL@_edm_other_src_silver.pos_na_temp temp 
left outer join @DB_LEVEL@_edm_other_src_silver.rep_office_info roi
on temp.salesofficenumber =roi.office_location
;


11.stg_to_pos_final

truncate table @DB_LEVEL@_na_cld_osc_gold.pos_na ;
insert into @DB_LEVEL@_na_cld_osc_gold.pos_na
select 
accountservicesales,
accountsubtype,
accounttype,
activated,
activedate,
assignmentterritory,
billtocustomeraddress,
billtocustomercity,
billtocustomercountry,
billtocustomerenterpriseindustry,
billtocustomergicsinudstrygroupdescription,
billtocustomergicssectordescription,
billtocustomergsc,
billtocustomerid,
billtocustomerindustry,
billtocustomername,
billtocustomernumber,
billtocustomerparentaccount,
billtocustomerparentname,
billtocustomerpostalcode,
billtocustomerreportingname,
billtocustomerstandardizedname,
billtocustomerstate,
billtocustomersubvertical,
billtocustomertype,
billtocustomervertical,
billtoenterpriseindustry,
billtogsc_flag,
billtoindustry,
billtoindustrycode,
billtononrevenueflag,
billtoparentaccount,
billtostandardizedname,
cdwsalesarea,
cdwsalesregion,
cdwsalessegment,
cloudlistprice,
coe,
country,
crossrefwithlesnumber,
currency,
endcustomeraccountrole,
endcustomeraddress,
endcustomercity,
endcustomercountry,
endcustomercustomertype1,
endcustomerenterpriseindustry,
endcustomergscflag,
endcustomerid,
endcustomerindustry1,
endcustomerindustrycode1,
endcustomername,
endcustomerparentaccount,
endcustomerpostalcode,
endcustomerstandardizedname,
endcustomerstate,
endcustomersubvertical,
endcustomervertical,
extendedlistprice,
extendedstandardcost,
gbu,
hashedbilltocustomername,
hashedendcustomername,
hashedshiptocustomername,
hashedsoldtocustomername,
/* internalofficefamily, --SO 750 Changes
internalofficename,
internalofficenumber,
internalofficeprincipalemail,
internalofficeprincipalname,
internalofficeregion,
internalofficesplit,
internalofficeterritory,
internalofficetype,
internalprincipalemail,
internalprincipalname, */
invoicedate,
invoicelinenumber,
invoicenumber,
level6,
listprice,
lob,
multiplier,
namedaccountofficeassign,
namedaccountsplit,
netsalesrevenue,
newlescrossref2,
oemtag,
officelocation,
officetype,
originalsplitpercent,
posprojectregistrationnumber,
possku,
postalcodesofficeassign,
productcategory,
productfamily,
producthierarchylevel1description,
producthierarchylevel2description,
producthierarchylevel3description,
producthierarchylevel4code,
producthierarchylevel4description,
quantityshipped,
recordid,
recordsource,
region,
resellerbranchname,
resellerbranchnumber,
resellermajorcode,
resellerminorcode,
resellername,
resellernumber,
resellerpartnerlevel,
resellerpartnertype,
resellerregion,
resellersalesofficename,
resellersalesofficenumber,
responseid,
sales_area,
salesofficefamily,
salesofficename,
salesofficenumber,
salesofficenumber2,
salesofficeprincipalemail,
salesofficeprincipalname,
salesofficeregion,
salesofficeterritory,
salesordernumber,
salesoutprimarykey,
salesregion,
salesregion2,
salesrepemail,
salesrepid,
salesrepname,
segment,
shiptocustomeraddress,
shiptocustomercity,
shiptocustomercountry,
shiptocustomerenterpriseindustry,
shiptocustomergsc,
shiptocustomerid,
shiptocustomerindustry1,
shiptocustomername,
shiptocustomernumber,
shiptocustomerparentaccount,
shiptocustomerparentname,
shiptocustomerpostalcode,
shiptocustomerstandardizedname,
shiptocustomerstate,
shiptocustomersubvertical,
shiptocustomertype1,
shiptocustomertype1_2,
shiptocustomervertical,
shiptoenterpriseindustry,
shiptogsc_flag,
shiptoindustry1,
shiptoparentaccount,
shiptostandardizedname,
sizecategory,
sku,
skudescription,
soldtocustomeraddress,
soldtocustomercity,
soldtocustomercountry,
soldtocustomercustomergsc,
soldtocustomercustomertype1,
soldtocustomerindustry1,
soldtocustomername,
soldtocustomernumber,
soldtocustomerparentaccount,
soldtocustomerpostalcode,
soldtocustomerstate,
soldtocustomersubvertical,
soldtocustomervertical,
sp1productflag,
sp1targetaccountflag,
sp2productflag,
sp2targetaccountflag,
--speed_dial,-- SO 750 Changes
splitpercent,
standard_products,
standardcost,
transactionamount,
transactiontype,
yearmonth,
intrachannelflag,
w_insert_dtm,
endcustomernumber,
billtocustomerclasscode,
endcustomerclasscode,
shiptocustomerclasscode,
soldtocustomerclasscode,
billtocustomerpartnerclasscode,
endcustomerpartnerclasscode,
shiptocustomerpartnerclasscode,
soldtocustomerpartnerclasscode,
billtooracleregistryid, 
endoracleregistryid,
shiptooracleregistryid,
soldtooracleregistryid,
billtocustomerindustry1,
billtocustomerindustry3,
endcustomerindustry3,
shiptocustomerindustry3,
soldtocustomerindustry3,
billtoreportingsubparent1,
endreportingsubparent1,
shiptoreportingsubparent1,
soldtoreportingsubparent1,
billtodefinitiveidnid,
enddefinitiveidnid,
shiptodefinitiveidnid,
soldtodefinitiveidnid,
billtodefinitiveidnidparentid,
enddefinitiveidnidparentid,
shiptodefinitiveidnidparentid,
soldtodefinitiveidnidparentid,
billtoncesleaid,
endncesleaid,
shiptoncesleaid,
soldtoncesleaid,
billtocustomerprovince,
endcustomerprovince,
shiptocustomerprovince,
soldtocustomerprovince,
billtooraclepartysitenumber,  
endoraclepartysitenumber,
shiptooraclepartysitenumber,
soldtooraclepartysitenumber,
billtodefinitiveid,
enddefinitiveid,
shiptodefinitiveid,
soldtodefinitiveid,
billtoncesschid,
endncesschid,
shiptoncesschid,
soldtoncesschid,
billtoaccounttype,
endaccounttype,
shiptoaccounttype,
soldtoaccounttype,
productcommissionclasscode,
billtoservicesmajoracc,  
endservicesmajoracc,
shiptoservicesmajoracc,
soldtoservicesmajoracc,   
billtocustomersubclass, 
endcustomersubclass,
shiptocustomersubclass,
soldtocustomersubclass,
serialnumber 

from @DB_LEVEL@_edm_other_src_silver.pos_na_stg ;

truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_temp ;
truncate table @DB_LEVEL@_edm_other_src_silver.pos_na_stg ;







